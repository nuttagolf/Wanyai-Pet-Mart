<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wan Yai Pet Mart POS (V.9.7.2 Pro UI)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        :root {
            --primary-color: #62B194;   
            --primary-dark: #4da083;    
            --secondary-color: #E8AC56; 
            --secondary-dark: #d6953e;
            --bg-color: #F9F7F0;        
            --text-dark: #4A4A4A;        
            --card-shadow: 0 4px 15px rgba(98, 177, 148, 0.15);
            --border-radius-btn: 50px;  
            --border-radius-card: 20px; 
        }
        
        body { 
            background-color: var(--bg-color); 
            font-family: 'Sarabun', sans-serif; 
            color: var(--text-dark);
            overflow-x: hidden;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 30c-1.5 0-2.8-1.2-2.8-2.8 0-1.5 1.2-2.8 2.8-2.8 1.5 0 2.8 1.2 2.8 2.8 0 1.5-1.2 2.8-2.8 2.8zm0-8c-1.5 0-2.8-1.2-2.8-2.8 0-1.5 1.2-2.8 2.8-2.8 1.5 0 2.8 1.2 2.8 2.8 0 1.5-1.2 2.8-2.8 2.8zm-6 5c-1.5 0-2.8-1.2-2.8-2.8 0-1.5 1.2-2.8 2.8-2.8 1.5 0 2.8 1.2 2.8 2.8 0 1.5-1.2 2.8-2.8 2.8zm12 0c-1.5 0-2.8-1.2-2.8-2.8 0-1.5 1.2-2.8 2.8-2.8 1.5 0 2.8 1.2 2.8 2.8 0 1.5-1.2 2.8-2.8 2.8zm-6 12c-3.3 0-6-2.7-6-6 0-1 .3-1.9.8-2.7.5-.7 1.2-1.2 2-1.5 1-.4 2.1-.6 3.2-.6 1.1 0 2.2.2 3.2.6.8.3 1.5.8 2 1.5.5.8.8 1.7.8 2.7 0 3.3-2.7 6-6 6z' fill='%2362B194' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        h1, h2, h3, h4, h5, h6, .brand-font { font-family: 'Fredoka', 'Sarabun', sans-serif; }
        
        /* Sidebar Styling */
        .sidebar { 
            min-height: 100vh; 
            background-color: rgba(255, 255, 255, 0.95);
            border-right: 1px solid #e9ecef; 
            position: fixed; 
            width: 260px; 
            z-index: 1000; 
            transition: 0.3s; 
            box-shadow: 2px 0 15px rgba(0,0,0,0.02);
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .sidebar-header { padding: 30px 25px; }
        .nav-link { 
            color: #888; 
            padding: 12px 25px; 
            margin: 8px 15px; 
            border-radius: var(--border-radius-btn); 
            transition: 0.2s; 
            font-weight: 500; 
        }
        .nav-link:hover { background-color: #f0fdf9; color: var(--primary-color); }
        .nav-link.active { 
            background-color: var(--primary-color); 
            color: white; 
            box-shadow: 0 4px 10px rgba(98, 177, 148, 0.4); 
        }
        .nav-link i { width: 30px; text-align: center; margin-right: 5px; }
        
        .main-content { margin-left: 260px; padding: 30px; transition: 0.3s; }
        .section-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Card & UI */
        .card-custom { 
            border: none; border-radius: var(--border-radius-card); 
            box-shadow: var(--card-shadow); background: white; 
            position: relative; overflow: hidden;
        }
        .card-custom::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); 
        }
        .card-custom:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(98, 177, 148, 0.2); }
        
        .product-card { 
            cursor: pointer; border: 2px solid #f5f5f5; border-radius: 15px; background: white; overflow: hidden; transition: 0.2s;
        }
        .product-card:hover { border-color: var(--secondary-color); transform: translateY(-3px); }
        .product-img { height: 140px; object-fit: cover; width: 100%; background-color: #f8f9fa; }
        
        .btn { border-radius: var(--border-radius-btn); font-weight: 600; padding: 8px 20px; }
        .btn-theme { background-color: var(--primary-color); color: white; border: none; }
        .btn-theme:hover { background-color: var(--primary-dark); color: white; }
        .btn-warning { background-color: var(--secondary-color) !important; color: white !important; border: none; }
        .btn-warning:hover { background-color: var(--secondary-dark) !important; }

        .text-primary { color: var(--primary-color) !important; }
        .text-warning { color: var(--secondary-color) !important; }
        .bg-light-primary { background-color: #eaf7f2; color: var(--primary-color); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #d1e7dd; border-radius: 4px; }
        
        /* Bill Slip */
        .bill-slip { font-family: 'Courier New', monospace; background: #fff; padding: 15px; border: 1px solid #ddd; position: relative; font-size: 14px; }
        .bill-slip::before, .bill-slip::after { content: ''; position: absolute; left: 0; width: 100%; height: 5px; background: radial-gradient(circle, #fff 5px, transparent 6px); background-size: 15px 15px; }
        .bill-slip::before { top: -5px; transform: rotate(180deg); }
        .bill-slip::after { bottom: -5px; }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 280px; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
            .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
            .mobile-overlay.active { display: block; }
        }
    </style>
</head>
<body>

<div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>
<div class="sidebar d-flex flex-column" id="sidebar">
    <div class="sidebar-header d-flex align-items-center gap-3">
        <div class="bg-white border border-2 text-warning rounded-circle d-flex justify-content-center align-items-center shadow-sm" style="width: 60px; height: 60px; border-color: var(--primary-color)!important; color: var(--secondary-color)!important;">
            <i class="fa-solid fa-paw fa-2x"></i>
        </div>
        <div style="line-height: 1.1;">
            <h5 class="fw-bold mb-0 brand-font" style="color: var(--primary-color); font-size: 1.4rem;">‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà</h5>
            <h6 class="fw-bold mb-0 brand-font" style="color: var(--secondary-color);">‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó</h6>
        </div>
    </div>
    
    <nav class="nav flex-column mt-3 flex-grow-1">
        <a class="nav-link active" onclick="showSection('dashboard')"><i class="fa-solid fa-chart-pie"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a>
        <a class="nav-link" onclick="showSection('pos')"><i class="fa-solid fa-cash-register"></i> ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</a>
        <a class="nav-link" onclick="showSection('products')"><i class="fa-solid fa-boxes-stacked"></i> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏™‡∏ï‡πä‡∏≠‡∏Å</a>
        <a class="nav-link" onclick="showSection('history')"><i class="fa-solid fa-clock-rotate-left"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≤‡∏¢</a>
        <a class="nav-link" onclick="showSection('purchase')"><i class="fa-solid fa-truck-ramp-box"></i> ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</a>
        <a class="nav-link" onclick="showSection('accounting')"><i class="fa-solid fa-calculator"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ & ‡∏Å‡∏≥‡πÑ‡∏£</a>
    </nav>

    <div class="p-3 border-top text-center">
        <small class="text-muted d-block mb-2">Wan Yai Pet Mart V.9.7.2</small>
        <a class="btn btn-sm btn-outline-secondary w-100" onclick="showSection('settings')" style="border-radius: 20px;"><i class="fa-solid fa-gear"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</a>
    </div>
</div>

<div class="main-content">
    <div class="d-md-none d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-white shadow-sm text-success" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        <span class="fw-bold text-success">‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó</span>
        <div style="width: 40px;"></div>
    </div>

    <div id="dashboard" class="section">
        <div class="section-header flex-wrap gap-2">
            <div>
                <h4 class="fw-bold mb-0 text-dark">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</h4>
                <small class="text-muted">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="dashDate"></span></small>
            </div>
            <div class="d-flex gap-2 align-items-center ms-auto">
                <select id="dashRange" class="form-select shadow-sm" style="width: auto; border-radius: 20px;" onchange="renderDashboard()">
                    <option value="0">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                    <option value="7">7 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</option>
                    <option value="15">15 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</option>
                    <option value="30">30 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</option>
                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                </select>
                <button class="btn btn-white bg-white border shadow-sm text-success" onclick="renderDashboard()"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-6 col-lg-3">
                <div class="card card-custom p-3 h-100 border-start border-0">
                    <div class="d-flex justify-content-between">
                        <div>
                            <small class="text-muted fw-bold">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</small>
                            <h3 id="totalSales" class="fw-bold text-primary my-1">0 ‡∏ø</h3>
                        </div>
                        <div class="bg-light-primary rounded-circle d-flex align-items-center justify-content-center" style="width:50px; height:50px;">
                             <i class="fa-solid fa-wallet fa-lg"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-muted small"><i class="fa-solid fa-receipt"></i> <span id="totalBills">0</span> ‡∏ö‡∏¥‡∏•</div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card card-custom p-3 h-100 border-start border-0">
                    <div class="d-flex justify-content-between">
                        <div>
                            <small class="text-muted fw-bold">‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô</small>
                            <h3 id="netProfit" class="fw-bold text-success my-1">0 ‡∏ø</h3>
                        </div>
                        <div class="text-success bg-light rounded-circle d-flex align-items-center justify-content-center" style="width:50px; height:50px;">
                             <i class="fa-solid fa-sack-dollar fa-lg"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-muted small">Margin: <span id="profitMargin" class="text-success fw-bold">0%</span></div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card card-custom p-3 h-100 border-start border-0">
                    <div class="d-flex justify-content-between">
                        <div>
                            <small class="text-muted fw-bold">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å</small>
                            <h3 id="totalStockValue" class="fw-bold text-warning my-1">0 ‡∏ø</h3>
                        </div>
                        <div class="text-warning bg-light rounded-circle d-flex align-items-center justify-content-center" style="width:50px; height:50px;">
                             <i class="fa-solid fa-boxes-stacked fa-lg"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-muted small">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏°‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô</div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card card-custom p-3 h-100 border-start border-0">
                    <div class="d-flex justify-content-between">
                        <div>
                            <small class="text-muted fw-bold">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°</small>
                            <h3 id="lowStockCount" class="fw-bold text-danger my-1">0</h3>
                        </div>
                        <div class="text-danger bg-light rounded-circle d-flex align-items-center justify-content-center" style="width:50px; height:50px;">
                             <i class="fa-solid fa-triangle-exclamation fa-lg"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-muted small">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå</div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-lg-8">
                <div class="card card-custom p-4 h-100">
                    <h6 class="fw-bold text-secondary mb-3"><i class="fa-solid fa-chart-line"></i> <span id="chartTitle">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</span></h6>
                    <div style="height: 300px;"><canvas id="mainChart"></canvas></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h6 class="fw-bold text-secondary mb-3"><i class="fa-solid fa-crown text-warning"></i> 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ (‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô)</h6>
                    <div style="height: 250px;"><canvas id="topProductChart"></canvas></div>
                    <div class="text-center mt-2 small text-muted">*‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á</div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-lg-8">
                <div class="card card-custom p-0 h-100">
                    <div class="p-3 border-bottom bg-white"><h6 class="fw-bold mb-0">üìù ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)</h6></div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center small">
                            <thead class="bg-light text-secondary"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th></tr></thead>
                            <tbody id="recentTxTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card card-custom p-0 h-100">
                    <div class="p-3 border-bottom bg-white d-flex justify-content-between"><h6 class="fw-bold mb-0 text-danger">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</h6></div>
                    <ul id="lowStockList" class="list-group list-group-flush small" style="max-height: 300px; overflow-y: auto;"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="pos" class="section" style="display:none;">
        <div class="row h-100 g-3">
            <div class="col-lg-8 d-flex flex-column h-100">
                <div class="card card-custom p-3 mb-3">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0" style="border-radius: 25px 0 0 25px;"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                        <input type="text" id="searchPos" class="form-control border-start-0 shadow-none" style="border-radius: 0 25px 25px 0;" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠/‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î)..." onkeyup="renderPOS()">
                    </div>
                </div>
                <div class="flex-grow-1 overflow-auto pe-1" style="max-height: 80vh;">
                    <div class="row g-2" id="productGrid"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card card-custom h-100 d-flex flex-column shadow-lg" style="border: 2px solid var(--primary-color);">
                    <div class="p-3 text-white rounded-top d-flex justify-content-between align-items-center" style="background-color: var(--primary-color);">
                        <h5 class="mb-0"><i class="fa-solid fa-basket-shopping"></i> ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</h5>
                        <span class="badge bg-white text-success fw-bold" id="cartCount">0</span>
                    </div>
                    <div class="flex-grow-1 overflow-auto p-2" id="cartItems" style="background-color: #fffdf9;"></div>
                    <div class="p-3 border-top bg-white rounded-bottom">
                        <div class="d-flex justify-content-between align-items-end mb-3">
                            <span class="text-muted">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                            <h2 class="text-success fw-bold mb-0" id="cartTotal">0 ‡∏ø</h2>
                        </div>
                        <button class="btn w-100 py-3 fw-bold fs-5 shadow-sm mb-2 text-white" style="background-color: var(--secondary-color); border:none;" onclick="checkout()">
                            <i class="fa-solid fa-cash-register"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (F2)
                        </button>
                        <button class="btn btn-outline-secondary w-100 btn-sm" onclick="clearCart()">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="products" class="section" style="display:none;">
        <div class="section-header">
            <h4 class="fw-bold text-dark">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
            <button class="btn btn-theme shadow-sm" onclick="openProductModal()"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>
        <div class="card card-custom p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary small">
                        <tr><th class="ps-4">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th><th>‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th class="text-end pe-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                    </thead>
                    <tbody id="stockTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="history" class="section" style="display:none;">
        <div class="section-header">
            <h4 class="fw-bold text-dark">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h4>
            <div></div>
        </div>
        <div class="card card-custom p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light"><tr><th class="ps-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th class="text-end pe-4">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th></tr></thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="purchase" class="section" style="display:none;">
        <h4 class="fw-bold mb-4 text-dark">‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å</h4>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card card-custom p-4">
                    <label class="form-label text-muted small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select id="purchase-product" class="form-select mb-3" onchange="updatePurchaseUnitCost()"><option value="">-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option></select>
                    
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label text-muted small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)</label>
                            <input type="number" id="purchase-qty" class="form-control" placeholder="0">
                        </div>
                        <div class="col">
                            <label class="form-label text-muted small">‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                            <input type="number" id="purchase-cost" class="form-control" placeholder="0.00">
                        </div>
                    </div>
                    <button class="btn btn-theme w-100" onclick="confirmPurchase()"><i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</button>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card card-custom p-4">
                    <h6 class="text-muted mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                    <div class="table-responsive">
                        <table class="table table-sm text-center align-middle">
                            <thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏•‡∏ö</th></tr></thead>
                            <tbody id="purchaseHistoryTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="accounting" class="section" style="display:none;">
        <div class="section-header">
            <h4 class="fw-bold text-dark">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ & ‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û)</h4>
            <small class="text-muted">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (Revenue - COGS - Expenses)</small>
        </div>

        <div class="row g-4">
            <div class="col-lg-5">
                <div class="card card-custom p-4 mb-4">
                    <h6 class="fw-bold text-danger mb-3"><i class="fa-solid fa-circle-minus"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h6>
                    <div class="mb-2">
                        <label class="small text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                        <input type="text" id="expenseTitle" class="form-control" placeholder="...">
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="small text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                            <input type="number" id="expenseAmount" class="form-control" placeholder="0.00">
                        </div>
                        <div class="col">
                            <label class="small text-muted">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <select id="expenseCat" class="form-select">
                                <option>‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ</option>
                                <option>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</option>
                                <option>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á</option>
                                <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-danger w-100 shadow-sm" onclick="addExpense()" style="border-radius: 25px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
                </div>

                <div class="card card-custom p-0" style="max-height: 400px; overflow-y:auto;">
                    <div class="p-3 border-bottom bg-light"><h6 class="mb-0 fw-bold">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6></div>
                    <ul class="list-group list-group-flush" id="expenseList"></ul>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card card-custom p-0 h-100 border-0 shadow-lg">
                    <div class="p-4 bg-white"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="settings" class="section" style="display:none;">
        <div class="container-fluid p-0">
            <h4 class="fw-bold mb-4 text-dark">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card card-custom p-4 text-center h-100">
                        <div class="text-primary mb-3"><i class="fa-solid fa-cloud-arrow-down fa-3x"></i></div>
                        <h5>‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)</h5>
                        <button class="btn btn-outline-primary w-100 mt-auto" onclick="exportData()" style="border-radius: 25px;">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-custom p-4 text-center h-100">
                        <div class="text-success mb-3"><i class="fa-solid fa-cloud-arrow-up fa-3x"></i></div>
                        <h5>‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)</h5>
                        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
                        <button class="btn btn-outline-success w-100 mt-auto" onclick="document.getElementById('importFile').click()" style="border-radius: 25px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-custom p-4 text-center h-100">
                        <div class="text-danger mb-3"><i class="fa-solid fa-triangle-exclamation fa-3x"></i></div>
                        <h5>‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Reset)</h5>
                        <button class="btn btn-outline-danger w-100 mt-auto" onclick="clearAllData()" style="border-radius: 25px;">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Global Data ---
    let products = JSON.parse(localStorage.getItem('products_v9')) || [];
    let transactions = JSON.parse(localStorage.getItem('transactions_v9')) || [];
    let purchases = JSON.parse(localStorage.getItem('purchases_v9')) || [];
    let expenses = JSON.parse(localStorage.getItem('expenses_v9')) || []; 
    let cart = [];
    let topProductChartInstance = null;
    let mainChartInstance = null;

    function generateAvatar(text) {
        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
        canvas.width = 200; canvas.height = 200;
        const colors = ['#62B194', '#E8AC56', '#4a6fa5', '#88b7a2', '#f7c59f'];
        let hash = 0; for (let i=0; i<text.length; i++) hash = text.charCodeAt(i) + ((hash << 5) - hash);
        ctx.fillStyle = colors[Math.abs(hash) % colors.length]; ctx.fillRect(0, 0, 200, 200);
        ctx.fillStyle = 'white'; ctx.font = 'bold 100px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(text ? text.charAt(0).toUpperCase() : "?", 100, 100);
        return canvas.toDataURL();
    }

    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0]; const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image(); img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const scaleFactor = 300 / img.width;
                    canvas.width = 300; canvas.height = img.height * scaleFactor;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    document.getElementById('prev-img').src = canvas.toDataURL('image/jpeg', 0.7);
                };
            }; reader.readAsDataURL(file);
        }
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('mobileOverlay').classList.toggle('active');
    }
    function showSection(id) {
        document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        const links = document.querySelectorAll('.nav-link');
        if(id === 'dashboard') links[0].classList.add('active');
        if(id === 'pos') { links[1].classList.add('active'); renderPOS(); }
        if(id === 'products') { links[2].classList.add('active'); renderStock(); }
        if(id === 'history') { links[3].classList.add('active'); renderHistory(); }
        if(id === 'purchase') { links[4].classList.add('active'); renderPurchaseSection(); }
        if(id === 'accounting') { links[5].classList.add('active'); renderAccounting(); }
        if(id === 'settings') links[6].classList.add('active');
        if(window.innerWidth < 768) toggleSidebar();
        if(id === 'dashboard') renderDashboard();
    }
    function saveData() {
        localStorage.setItem('products_v9', JSON.stringify(products));
        localStorage.setItem('transactions_v9', JSON.stringify(transactions));
        localStorage.setItem('purchases_v9', JSON.stringify(purchases));
        localStorage.setItem('expenses_v9', JSON.stringify(expenses));
    }

    // --- DASHBOARD (Updated with Dropship Logic) ---
    function renderDashboard() {
        const today = new Date();
        document.getElementById('dashDate').innerText = today.toLocaleDateString('th-TH');
        
        const rangeVal = document.getElementById('dashRange').value;
        let startDate = new Date(); startDate.setHours(0,0,0,0);
        if(rangeVal !== '0' && rangeVal !== 'all') startDate.setDate(today.getDate() - parseInt(rangeVal));
        else if (rangeVal === 'all') startDate = new Date(0);

        const filteredTxs = transactions.filter(t => {
            let tTime = t.timestamp ? t.timestamp : new Date(t.date).getTime();
            if(rangeVal === '0') {
                const tomorrow = new Date(startDate); tomorrow.setDate(tomorrow.getDate() + 1);
                return tTime >= startDate.getTime() && tTime < tomorrow.getTime();
            }
            return tTime >= startDate.getTime();
        });

        let totalSales = 0, totalProfit = 0;
        let shopSales = 0, dropshipSales = 0; // Separate sales vars

        filteredTxs.forEach(t => { 
            totalSales += t.total; 
            totalProfit += t.profit; 
            if (t.isDropship) {
                dropshipSales += t.total;
            } else {
                shopSales += t.total;
            }
        });
        
        let stockVal = 0, lowStock = [];
        products.forEach(p => { 
            stockVal += (p.stock * p.cost);
            if(p.stock <= 5) lowStock.push(p);
        });

        // Updated HTML for Total Sales
        document.getElementById('totalSales').innerHTML = `
            ${totalSales.toLocaleString()} ‡∏ø
            <div style="font-size: 10px; margin-top: 5px;" class="text-muted">
                ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô: ${shopSales.toLocaleString()} | Dropship: ${dropshipSales.toLocaleString()}
            </div>
        `;

        document.getElementById('netProfit').innerText = totalProfit.toLocaleString() + ' ‡∏ø';
        document.getElementById('totalBills').innerText = filteredTxs.length;
        document.getElementById('profitMargin').innerText = totalSales > 0 ? ((totalProfit/totalSales)*100).toFixed(1) + '%' : '0%';
        document.getElementById('totalStockValue').innerText = stockVal.toLocaleString() + ' ‡∏ø';
        document.getElementById('lowStockCount').innerText = lowStock.length;

        // Chart: Sales Trend
        const ctxMain = document.getElementById('mainChart').getContext('2d');
        if(mainChartInstance) mainChartInstance.destroy();
        let chartLabels = [], chartData = [], chartTitle = "";
        
        if (rangeVal === '0') {
            chartTitle = "‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)";
            chartLabels = Array.from({length:17}, (_,i)=> (i+6)+":00");
            let hourlyMap = new Array(24).fill(0);
            filteredTxs.forEach(t => {
                let hour = t.timestamp ? new Date(t.timestamp).getHours() : 0;
                if(hour >= 0 && hour < 24) hourlyMap[hour] += t.total;
            });
            chartData = hourlyMap.slice(6, 23);
        } else {
            chartTitle = "‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)";
            let dateMap = {};
            filteredTxs.forEach(t => {
                let d = t.date.split(' ')[0];
                if(!dateMap[d]) dateMap[d] = 0; dateMap[d] += t.total;
            });
            let sortedDates = Object.keys(dateMap).sort((a,b) => {
                let [d1,m1,y1] = a.split('/'); let [d2,m2,y2] = b.split('/');
                return new Date(y1,m1-1,d1) - new Date(y2,m2-1,d2);
            });
            chartLabels = sortedDates; chartData = sortedDates.map(d => dateMap[d]);
        }
        document.getElementById('chartTitle').innerText = chartTitle;
        mainChartInstance = new Chart(ctxMain, {
            type: rangeVal === '0' ? 'line' : 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)', data: chartData,
                    borderColor: '#62B194', backgroundColor: rangeVal === '0' ? 'rgba(98, 177, 148, 0.1)' : '#62B194',
                    fill: rangeVal === '0', tension: 0.4, borderRadius: 5
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
        });

        // Top Products
        let productMap = {};
        filteredTxs.forEach(t => {
            t.items.forEach(i => {
                let key = i.name;
                let qty = Number(i.qty) || 0; 
                if(!productMap[key]) productMap[key] = 0;
                productMap[key] += qty;
            });
        });
        
        let sortedProd = Object.keys(productMap)
            .map(key => ({name: key, qty: productMap[key]}))
            .sort((a,b) => b.qty - a.qty)
            .slice(0, 5);
        
        const ctxTop = document.getElementById('topProductChart').getContext('2d');
        if(topProductChartInstance) topProductChartInstance.destroy();
        topProductChartInstance = new Chart(ctxTop, {
            type: 'doughnut',
            data: {
                labels: sortedProd.map(x=>x.name),
                datasets: [{
                    data: sortedProd.map(x=>x.qty),
                    backgroundColor: ['#62B194', '#E8AC56', '#4a6fa5', '#88b7a2', '#f7c59f'],
                    borderWidth: 2, borderColor: '#ffffff'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'right', labels:{boxWidth:12}} } }
        });

        // Recent Tx
        const recentBody = document.getElementById('recentTxTable');
        recentBody.innerHTML = '';
        filteredTxs.slice().reverse().slice(0, 10).forEach(t => {
            let itemStr = t.items[0] ? t.items[0].name + (t.items.length>1 ? ` (+${t.items.length-1})`:'') : '-';
            recentBody.innerHTML += `<tr><td>${t.date.split(' ')[0]}</td><td>${t.date.split(' ')[1]}</td><td><span class="badge bg-light text-dark border">${t.id}</span></td><td class="text-start">${itemStr}</td><td class="fw-bold text-success">${t.total.toLocaleString()}</td></tr>`;
        });
        if(filteredTxs.length === 0) recentBody.innerHTML = '<tr><td colspan="5" class="text-muted py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</td></tr>';

        // Low Stock
        const list = document.getElementById('lowStockList');
        list.innerHTML = '';
        lowStock.forEach(p => {
            list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><div class="d-flex align-items-center"><img src="${p.img}" class="rounded me-2" style="width:30px;height:30px;"><span>${p.name}</span></div><span class="badge bg-danger rounded-pill">${p.stock}</span></li>`;
        });
        if(lowStock.length===0) list.innerHTML = '<li class="list-group-item text-center text-success border-0"><i class="fa-solid fa-check-circle"></i> ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥</li>';
    }

    // --- POS ---
    function renderPOS() {
        const grid = document.getElementById('productGrid');
        const term = document.getElementById('searchPos').value.toLowerCase();
        grid.innerHTML = '';
        const filtered = products.filter(p => p.name.toLowerCase().includes(term));
        if(filtered.length === 0) { grid.innerHTML = '<div class="col-12 text-center text-muted py-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>'; return; }
        filtered.forEach(p => {
            let isOut = p.stock <= 0;
            let priceTxt = (p.options && p.options.length) ? Math.min(...p.options.map(o=>o.price)) + "‡∏ø+" : "N/A";
            grid.innerHTML += `
            <div class="col-6 col-md-4 col-lg-3" onclick="selectProduct(${p.id})">
                <div class="card product-card h-100 ${isOut ? 'opacity-50 grayscale' : ''}">
                    <div class="position-relative">
                        <img src="${p.img}" class="product-img">
                        <span class="position-absolute top-0 end-0 m-2 badge ${isOut?'bg-danger':'bg-success'} shadow">${p.stock}</span>
                    </div>
                    <div class="card-body p-2 text-center">
                        <small class="fw-bold d-block text-truncate text-dark">${p.name}</small>
                        <span class="text-warning fw-bold">${priceTxt}</span>
                    </div>
                </div>
            </div>`;
        });
    }

    function selectProduct(id) {
        const p = products.find(x => x.id === id);
        if(!p || p.stock <= 0) return Swal.fire({icon:'error', title:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î', text:'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å', timer:1000, showConfirmButton:false});
        const currentInCart = cart.reduce((acc, c) => (c.id === id ? acc + (c.qty * (c.cutStock||1)) : acc), 0);
        if (currentInCart >= p.stock) return Swal.fire({icon: 'warning', title: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠', text: `‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å ${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô`, timer: 2000, showConfirmButton: false});

        let html = '<div class="d-grid gap-2">';
        p.options.forEach((o, i) => {
            html += `<button class="btn btn-theme d-flex justify-content-between py-2" style="border-radius:25px;" onclick="addToCart(${p.id}, ${i}); Swal.close()"><span>${o.name}</span><b>${o.price}‡∏ø</b></button>`;
        });
        html += '<hr class="text-muted my-2 opacity-25">';
        html += `<button class="btn btn-warning d-flex justify-content-between py-2 fw-bold" style="border-radius:25px;" onclick="openCustomSale(${p.id})"><span><i class="fa-solid fa-pen-to-square"></i> ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</span><span>‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤</span></button></div>`;
        Swal.fire({ title: p.name, html: html, showConfirmButton: false, confirmButtonColor: '#62B194' });
    }

    // --- Custom Sale (with Cost Input) ---
    async function openCustomSale(id) {
        Swal.close(); 
        const p = products.find(x => x.id === id);
        const { value: formValues } = await Swal.fire({
            title: '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á',
            html: `
                <div class="mb-2 text-start text-muted small">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <b>${p.name}</b> (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.stock})</div>
                <div class="row g-2">
                    <div class="col-4">
                        <label class="small fw-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label>
                        <input id="swal-custom-price" class="form-control text-center" type="number" placeholder="0" style="border-radius:15px;">
                    </div>
                    <div class="col-4">
                        <label class="small fw-bold text-muted">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                        <input id="swal-custom-cost" class="form-control text-center" type="number" value="${p.cost}" style="border-radius:15px;">
                    </div>
                    <div class="col-4">
                        <label class="small fw-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                        <input id="swal-custom-qty" class="form-control text-center" type="number" value="1" style="border-radius:15px;">
                    </div>
                </div>`,
            focusConfirm: false, showCancelButton: true, confirmButtonText: '‡πÄ‡∏û‡∏¥‡πà‡∏°', confirmButtonColor: '#E8AC56',
            preConfirm: () => [
                document.getElementById('swal-custom-price').value, 
                document.getElementById('swal-custom-qty').value,
                document.getElementById('swal-custom-cost').value
            ]
        });

        if (formValues) {
            const price = Number(formValues[0]); 
            const qty = Number(formValues[1]);
            const cost = Number(formValues[2]);

            if(!price || !qty || qty <= 0) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '', 'error');
            
            // Logic: Do not check stock limit here, allowing for potential dropship later
            
            const exist = cart.find(c => c.id === id && c.optionName === '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á' && c.price === price);
            if(exist) { exist.qty += qty; } 
            else { cart.push({ id: p.id, name: p.name, optionName: '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á', price: price, cutStock: 1, qty: qty, cost: cost }); }
            
            renderCart(); 
            Swal.fire({icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß', timer: 1000, showConfirmButton: false});
        }
    }

    function addToCart(pid, optIdx) {
        const p = products.find(x => x.id === pid); const opt = p.options[optIdx];
        const currentInCart = cart.reduce((acc, c) => (c.id === pid ? acc + (c.qty * (c.cutStock||1)) : acc), 0);
        const required = opt.cutStock || 1;
        if ((currentInCart + required) > p.stock) return Swal.fire({toast: true, position: 'top-end', icon: 'warning', title: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠!', timer: 2000, showConfirmButton: false});
        const exist = cart.find(c => c.id === pid && c.optionName === opt.name);
        if(exist) exist.qty++; else cart.push({ id: p.id, name: p.name, optionName: opt.name, price: opt.price, cutStock: required, qty: 1 });
        renderCart();
    }

    function renderCart() {
        const div = document.getElementById('cartItems'); let total = 0, count = 0;
        let html = '<ul class="list-group list-group-flush small">';
        cart.forEach((c, i) => {
            total += c.price * c.qty; count += c.qty;
            html += `<li class="list-group-item d-flex justify-content-between align-items-center px-1 bg-transparent"><div class="text-truncate" style="max-width: 130px;"><span class="fw-bold text-dark">${c.name}</span><br><span class="text-muted" style="font-size:0.8em">${c.optionName} (${c.price}x${c.qty})</span></div><div><span class="fw-bold me-2 text-dark">${(c.price*c.qty).toLocaleString()}</span><i class="fa-solid fa-trash text-danger" style="cursor:pointer" onclick="cart.splice(${i},1);renderCart()"></i></div></li>`;
        });
        div.innerHTML = cart.length ? html+'</ul>' : '<div class="text-center text-muted mt-5 opacity-50"><i class="fa-solid fa-basket-shopping fa-3x"></i><br>‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>';
        document.getElementById('cartTotal').innerText = total.toLocaleString() + ' ‡∏ø';
        document.getElementById('cartCount').innerText = count;
    }

    // --- Updated Checkout (Fixed Bug: Button not clickable if unchecked) ---
    function checkout() {
        if(cart.length === 0) return;
        const total = cart.reduce((sum, c) => sum + (c.price * c.qty), 0);
        
        Swal.fire({
            title: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', 
            html: `
                <h3 class="text-dark fw-bold mb-3">${total.toLocaleString()} ‡∏ö‡∏≤‡∏ó</h3>
                <div class="form-check d-inline-block text-start p-2 border rounded bg-light">
                    <input class="form-check-input" type="checkbox" id="isDropshipBill">
                    <label class="form-check-label text-muted" for="isDropshipBill">
                        üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Dropship / Pre-order<br>
                        <small>(‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô + ‡πÅ‡∏¢‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡πâ)</small>
                    </label>
                </div>
            `,
            showDenyButton: true, showCancelButton: true, confirmButtonText: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', denyButtonText: '‡πÇ‡∏≠‡∏ô/‡∏™‡πÅ‡∏Å‡∏ô', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#62B194', denyButtonColor: '#4a6fa5',
            // Return Object to ensure truthy value so Modal closes
            preConfirm: () => ({ isDropship: document.getElementById('isDropshipBill').checked }),
            preDeny: () => ({ isDropship: document.getElementById('isDropshipBill').checked })
        }).then((res) => {
            // Extract value safely from the object
            const isDropship = (res.value && res.value.isDropship) || false;
            
            if(res.isConfirmed) processTransaction(total, 'cash', isDropship);
            else if(res.isDenied) processTransaction(total, 'transfer', isDropship);
        });
    }

    // --- Updated Process Transaction (Handle Stock Logic) ---
    function processTransaction(saleTotal, paymentMethod, isDropship = false) {
        let costTotal = 0;
        
        cart.forEach(c => {
            let p = products.find(x => x.id === c.id);
            if(p) { 
                if (!isDropship) {
                    let cut = c.cutStock * c.qty; 
                    p.stock -= cut; 
                }
                // Use Custom Cost if available, else average cost
                let unitCost = (c.cost !== undefined) ? c.cost : p.cost;
                costTotal += (unitCost * c.qty); 
            }
        });

        const tx = { 
            id: Date.now().toString().slice(-6), 
            timestamp: Date.now(), 
            date: new Date().toLocaleString('th-TH'), 
            items: [...cart], 
            total: saleTotal, 
            profit: saleTotal - costTotal, 
            paymentMethod: paymentMethod,
            isDropship: isDropship
        };
        
        transactions.push(tx); 
        saveData(); 
        cart = []; 
        renderCart(); 
        renderPOS(); 
        renderDashboard();
        openBillModal(tx.id);
    }

    function openBillModal(txId) {
        const tx = transactions.find(t => t.id === txId); if(!tx) return;
        let itemsHtml = ''; tx.items.forEach(i => { itemsHtml += `<div class="d-flex justify-content-between mb-1"><span>${i.name} x${i.qty}</span><span>${(i.price * i.qty).toLocaleString()}</span></div>`; });
        const payTxt = tx.paymentMethod === 'transfer' ? '‡πÇ‡∏≠‡∏ô/‡∏™‡πÅ‡∏Å‡∏ô' : '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
        const typeTxt = tx.isDropship ? '<br><small class="text-warning">[Dropship/Pre-order]</small>' : '';
        const slipHtml = `<div class="bill-slip"><div class="text-center mb-3 border-bottom border-dark pb-2"><h5 class="fw-bold mb-0">‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó</h5><small>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</small><br><small>${tx.date}</small><br><small>#${tx.id}</small>${typeTxt}</div><div class="mb-3 border-bottom border-dark pb-2">${itemsHtml}</div><div class="d-flex justify-content-between fw-bold fs-5"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span>${tx.total.toLocaleString()} ‡∏ø</span></div><div class="d-flex justify-content-between text-muted small mt-1"><span>‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢</span><span>${payTxt}</span></div></div>`;
        Swal.fire({ html: slipHtml, showCloseButton: true, showDenyButton: true, confirmButtonText: '‡∏õ‡∏¥‡∏î', denyButtonText: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', confirmButtonColor: '#62B194', denyButtonColor: '#4a6fa5' }).then((res) => {
            if (res.isDenied) {
                let text = `[‡∏ö‡∏¥‡∏•] ‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó\n${tx.date}\n#${tx.id}\n----------------\n`;
                tx.items.forEach(i => text += `${i.name} x${i.qty} = ${i.price*i.qty}\n`);
                text += `----------------\n‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${tx.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
                navigator.clipboard.writeText(text); Swal.fire({icon:'success',title:'‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß',timer:1000,showConfirmButton:false});
            }
        });
    }

    function clearCart() { cart=[]; renderCart(); }

    async function openProductModal(id = null) {
        const p = id ? products.find(x=>x.id===id) : { name:'', cost:0, stock:0, img:'', options:[{name:'‡∏õ‡∏Å‡∏ï‡∏¥', price:0, cutStock:1}] };
        if(!p.img) p.img = generateAvatar(p.name||"?");
        let optHtml = p.options.map(o => `<div class="input-group mb-2 opt-row"><input type="text" class="form-control opt-name" value="${o.name}" style="border-radius: 15px 0 0 15px;"><input type="number" class="form-control opt-price" value="${o.price}"><input type="number" class="form-control opt-cut" value="${o.cutStock}"><button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()" style="border-radius: 0 15px 15px 0;">X</button></div>`).join('');
        const { value: form } = await Swal.fire({
            title: id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà', width: 600,
            html: `<div class="text-start"><div class="text-center mb-3"><img id="prev-img" src="${p.img}" class="rounded shadow-sm border" style="width:100px;height:100px;object-fit:cover; border-radius: 15px;"><div class="mt-2"><label class="btn btn-sm btn-light border" style="border-radius:20px;">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ <input type="file" hidden accept="image/*" onchange="handleImageUpload(this)"></label></div></div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="swal-name" class="form-control mb-2" value="${p.name}" style="border-radius:15px;"><div class="row mb-2"><div class="col"><label>‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</label><input type="number" id="swal-cost" class="form-control" value="${p.cost}" style="border-radius:15px;"></div><div class="col"><label>‡∏™‡∏ï‡πä‡∏≠‡∏Å</label><input type="number" id="swal-stock" class="form-control" value="${p.stock}" style="border-radius:15px;"></div></div><label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label><div id="opt-container">${optHtml}</div><button type="button" class="btn btn-sm w-100 mt-2 text-white" style="background-color: var(--secondary-color); border-radius:20px;" onclick="addOptRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</button></div>`,
            confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', showCancelButton: true, confirmButtonColor: '#62B194',
            preConfirm: () => {
                const opts = []; document.querySelectorAll('.opt-row').forEach(row => { opts.push({ name: row.querySelector('.opt-name').value, price: Number(row.querySelector('.opt-price').value), cutStock: Number(row.querySelector('.opt-cut').value) }); });
                return { name: document.getElementById('swal-name').value, cost: Number(document.getElementById('swal-cost').value), stock: Number(document.getElementById('swal-stock').value), img: document.getElementById('prev-img').src, options: opts };
            }
        });
        if(form) { if(id) { const idx = products.findIndex(x=>x.id===id); products[idx] = {id, ...form}; } else { products.push({id:Date.now(), ...form}); } saveData(); renderStock(); renderPOS(); renderDashboard(); }
    }

    window.addOptRow = function() {
        const div = document.createElement('div'); div.className = 'input-group mb-2 opt-row';
        div.innerHTML = `<input class="form-control opt-name" value="‡∏õ‡∏Å‡∏ï‡∏¥" style="border-radius: 15px 0 0 15px;"><input type="number" class="form-control opt-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤"><input type="number" class="form-control opt-cut" value="1"><button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()" style="border-radius: 0 15px 15px 0;">X</button>`;
        document.getElementById('opt-container').appendChild(div);
    };

    function renderStock() {
        const tb = document.getElementById('stockTable'); tb.innerHTML = '';
        products.forEach(p => {
            let price = p.options.map(o=>o.price).join('/');
            tb.innerHTML += `<tr><td class="ps-4"><div class="d-flex align-items-center"><img src="${p.img}" style="width:40px;height:40px;object-fit:cover;" class="rounded border me-2"><span>${p.name}</span></div></td><td>${price}</td><td>${p.cost}</td><td class="${p.stock<=5?'text-danger fw-bold':''}">${p.stock}</td><td class="text-end pe-4"><button class="btn btn-sm btn-light border" onclick="openProductModal(${p.id})"><i class="fa-solid fa-pen"></i></button> <button class="btn btn-sm btn-light border text-danger" onclick="delProd(${p.id})"><i class="fa-solid fa-trash"></i></button></td></tr>`;
        });
    }
    function delProd(id) { Swal.fire({title:'‡∏•‡∏ö?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed){products=products.filter(x=>x.id!==id);saveData();renderStock();renderPOS();}}) }

    function renderHistory() {
        const tb = document.getElementById('historyTable'); tb.innerHTML = '';
        transactions.slice().reverse().slice(0,50).forEach(t => {
            let payIcon = t.paymentMethod === 'transfer' ? '<i class="fa-solid fa-qrcode text-primary"></i>' : '<i class="fa-solid fa-money-bill text-success"></i>';
            // Show dropship badge in history if needed, or just normal view
            let dsBadge = t.isDropship ? ' <span class="badge bg-warning text-dark" style="font-size:0.6em">Drop</span>' : '';
            tb.innerHTML += `<tr><td class="ps-4">${t.date}</td><td>${payIcon}</td><td>${t.id}${dsBadge}</td><td>${t.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td><td class="fw-bold text-success">${t.total.toLocaleString()}</td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-primary me-1" onclick="openBillModal('${t.id}')"><i class="fa-solid fa-eye"></i></button><button class="btn btn-sm btn-outline-danger" onclick="delBill('${t.id}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
        });
    }
    async function delBill(id) {
        const {value:pass} = await Swal.fire({title:'Admin Password', input:'password'});
        if(pass === 'admin') { 
            const idx = transactions.findIndex(x=>x.id===id);
            if(idx > -1) {
                // If not dropship, return stock
                if(!transactions[idx].isDropship) {
                    transactions[idx].items.forEach(i => { let p = products.find(x=>x.id===i.id); if(p) p.stock += (i.qty * i.cutStock); });
                }
                transactions.splice(idx,1); saveData(); renderHistory(); renderDashboard(); Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß','‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
            }
        } else if(pass) Swal.fire('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î','','error');
    }

    function renderPurchaseSection() {
        const sel = document.getElementById('purchase-product'); sel.innerHTML = '<option value="">-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
        products.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
        const tb = document.getElementById('purchaseHistoryTable'); tb.innerHTML = '';
        purchases.slice().reverse().slice(0,10).forEach((p, i) => { tb.innerHTML += `<tr><td>${p.date.split(' ')[0]}</td><td>${p.productName}</td><td class="text-success">+${p.qty}</td><td>${p.unitCost}</td><td><button class="btn btn-sm btn-light text-danger" onclick="delPurchase(${purchases.length-1-i})"><i class="fa-solid fa-trash"></i></button></td></tr>`; });
    }
    function updatePurchaseUnitCost() { let p = products.find(x=>x.id==document.getElementById('purchase-product').value); if(p) document.getElementById('purchase-cost').value = p.cost; }
    function confirmPurchase() {
        let id = Number(document.getElementById('purchase-product').value), qty = Number(document.getElementById('purchase-qty').value), cost = Number(document.getElementById('purchase-cost').value);
        if(!id || !qty) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');
        let p = products.find(x=>x.id===id);
        if (p.stock <= 0) { p.cost = cost; p.stock += qty; } else { let oldVal = p.stock * p.cost, newVal = qty * cost; p.stock += qty; p.cost = Number(((oldVal+newVal)/p.stock).toFixed(2)); }
        purchases.push({date:new Date().toLocaleString('th-TH'), productName:p.name, productId:p.id, qty, unitCost:cost});
        saveData(); renderPurchaseSection(); Swal.fire({icon:'success',title:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß',timer:1000,showConfirmButton:false, confirmButtonColor: '#62B194'}); document.getElementById('purchase-qty').value='';
    }
    function delPurchase(idx) {
        const p = purchases[idx]; const prod = products.find(x=>x.id===p.productId);
        if(prod && prod.stock >= p.qty) { prod.stock -= p.qty; purchases.splice(idx,1); saveData(); renderPurchaseSection(); } else { Swal.fire('‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏Ç‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß','error'); }
    }

    // --- Updated Accounting UI (Professional Look) ---
    function renderAccounting() {
        let totalRevenue = 0;
        let totalCOGS = 0; 
        let shopCOGS = 0;  
        let dropshipCOGS = 0; 

        transactions.forEach(t => { 
            totalRevenue += t.total; 
            let billCost = t.total - t.profit;
            totalCOGS += billCost;

            if (t.isDropship) {
                dropshipCOGS += billCost;
            } else {
                shopCOGS += billCost;
            }
        });

        const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
        const grossProfit = totalRevenue - totalCOGS; 
        const netProfit = grossProfit - totalExpenses;

        // Target the container in the accounting section
        const plContainer = document.querySelector('#accounting .col-lg-7 .card .p-4');
        plContainer.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                <h5 class="fw-bold text-dark m-0">üìÑ ‡∏á‡∏ö‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô <span class="text-muted fw-light fs-6">(Profit & Loss)</span></h5>
                <small class="text-muted">${new Date().toLocaleDateString('th-TH', {month:'long', year:'numeric'})}</small>
            </div>

            <div class="d-flex justify-content-between align-items-end mb-2">
                <span class="text-secondary fw-bold">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Revenue)</span>
                <span class="fw-bold fs-5 text-dark">${totalRevenue.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
            </div>

            <div class="d-flex justify-content-between align-items-end mb-1">
                <span class="text-danger fw-bold"><i class="fa-solid fa-minus me-1" style="font-size:0.8em"></i> ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ (COGS)</span>
                <span class="fw-bold fs-5 text-danger">-${totalCOGS.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
            </div>

            <div class="d-flex justify-content-end mb-4">
                <div class="bg-light rounded p-2 px-3 border" style="font-size: 0.85rem; min-width: 200px;">
                    <div class="d-flex justify-content-between text-muted mb-1">
                        <span><i class="fa-solid fa-store me-1"></i> ‡∏ó‡∏∏‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</span>
                        <span>${shopCOGS.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                    </div>
                    <div class="d-flex justify-content-between text-muted border-top pt-1">
                        <span><i class="fa-solid fa-box-open me-1"></i> Dropship</span>
                        <span>${dropshipCOGS.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center p-3 bg-light-primary rounded-3 mb-4 shadow-sm" style="border-left: 5px solid var(--primary-color);">
                <span class="fw-bold text-primary">‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô (Gross Profit)</span>
                <span class="fw-bold fs-4 text-primary">${grossProfit.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25 border-dashed">
                <span class="text-secondary"><i class="fa-solid fa-minus me-1" style="font-size:0.8em"></i> ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (Expenses)</span>
                <span class="text-danger fw-bold">-${totalExpenses.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
            </div>

            <div class="text-center py-2">
                <small class="text-uppercase text-muted letter-spacing-2" style="letter-spacing: 2px;">Net Profit</small>
                <h1 class="fw-bold display-4 my-0 ${netProfit >= 0 ? 'text-success' : 'text-danger'}">
                    ${netProfit.toLocaleString(undefined, {minimumFractionDigits:2})}
                </h1>
                <span class="badge rounded-pill mt-2 px-3 py-2 ${netProfit >= 0 ? 'bg-success bg-opacity-10 text-success' : 'bg-danger bg-opacity-10 text-danger'}">
                    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${netProfit >= 0 ? '‡∏Å‡∏≥‡πÑ‡∏£' : '‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô'}
                </span>
            </div>
        `;

        const list = document.getElementById('expenseList'); list.innerHTML = '';
        expenses.slice().reverse().forEach((e, i) => { 
            list.innerHTML += `
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2 border-bottom">
                <div>
                    <span class="fw-bold d-block text-dark">${e.title}</span>
                    <small class="text-muted"><i class="fa-regular fa-calendar me-1"></i>${e.date} ‚Ä¢ <span class="badge bg-light text-secondary border">${e.category}</span></small>
                </div>
                <div class="text-end">
                    <span class="text-danger fw-bold">-${e.amount.toLocaleString()}</span>
                    <button class="btn btn-sm text-muted ms-2 p-0" onclick="delExpense(${expenses.length-1-i})"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </li>`; 
        });
    }

    function addExpense() {
        const title = document.getElementById('expenseTitle').value, amount = Number(document.getElementById('expenseAmount').value), cat = document.getElementById('expenseCat').value;
        if(!title || amount <= 0) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        expenses.push({ date: new Date().toLocaleDateString('th-TH'), title, amount, category: cat });
        saveData(); document.getElementById('expenseTitle').value = ''; document.getElementById('expenseAmount').value = ''; renderAccounting();
    }
    function delExpense(idx) { expenses.splice(idx, 1); saveData(); renderAccounting(); }

    function exportData() {
        const data = JSON.stringify({ products, transactions, purchases, expenses });
        const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `wanyai_backup_v9.7.2_${new Date().toISOString().slice(0,10)}.json`; a.click();
    }

    function importData(input) {
        const file = input.files[0]; if(!file) return; const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.products && data.transactions) {
                    Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?',text:"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ",icon:'warning',showCancelButton:true}).then(r=>{if(r.isConfirmed){
                        localStorage.setItem('products_v9', JSON.stringify(data.products)); localStorage.setItem('transactions_v9', JSON.stringify(data.transactions));
                        localStorage.setItem('purchases_v9', JSON.stringify(data.purchases || [])); localStorage.setItem('expenses_v9', JSON.stringify(data.expenses || []));
                        location.reload();
                    }});
                } else Swal.fire('‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','','error');
            } catch(err) { Swal.fire('Error','','error'); }
        }; reader.readAsText(file);
    }
    function clearAllData() { Swal.fire({title:'‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?',icon:'warning',showCancelButton:true}).then(r=>{if(r.isConfirmed){localStorage.clear();location.reload();}}); }

    renderDashboard();
</script>
</body>
</html>
