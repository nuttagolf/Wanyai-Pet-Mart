<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô ‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó (V.6.6 Stock Correction)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        body { background-color: #f0f7f4; font-family: 'Sarabun', sans-serif; }
        .sidebar { min-height: 100vh; background-color: #2d6a4f; color: white; }
        .nav-link { color: rgba(255,255,255,0.8); cursor: pointer; padding: 15px 20px; border-radius: 0 25px 25px 0; margin-bottom: 5px; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background-color: #40916c; color: white; font-weight: bold; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .card-custom { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.3s; background: white; }
        .product-card { cursor: pointer; border: 2px solid transparent; overflow: hidden; position: relative; transition: 0.2s; }
        .product-card:hover { border-color: #40916c; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .product-img { height: 120px; object-fit: cover; background-color: #e9ecef; width: 100%; }
        .btn-green { background-color: #2d6a4f; color: white; }
        .btn-green:hover { background-color: #1b4332; color: white; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        .option-btn { transition: 0.2s; border: 1px solid #ddd; }
        .option-btn:hover { background-color: #e9ecef; border-color: #2d6a4f; transform: scale(1.02); }
        
        /* Bill Style */
        .bill-wrapper { font-family: 'Courier New', monospace; text-align: left; font-size: 14px; color: #333; background: #fff; padding: 10px; border: 1px dashed #999; }
        .bill-header { text-align: center; border-bottom: 1px dashed #333; padding-bottom: 10px; margin-bottom: 10px; }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .bill-total { border-top: 1px dashed #333; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar p-0 d-none d-md-block fixed-top" style="height:100vh; z-index:1000;">
            <div class="p-4 text-center">
                <div class="bg-white rounded-circle d-inline-flex justify-content-center align-items-center mb-2 shadow-sm" style="width: 70px; height: 70px;">
                    <i class="fa-solid fa-paw fa-2x" style="color:#2d6a4f"></i>
                </div>
                <h5 class="fw-bold mt-2">‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà<br>‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó</h5>
                <span class="badge bg-danger text-white rounded-pill">V.6.6 Stock Fix</span>
            </div>
            <nav class="nav flex-column pe-2">
                <a class="nav-link active" onclick="showSection('dashboard')"><i class="fa-solid fa-chart-pie me-2"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≤‡∏ô</a>
                <a class="nav-link" onclick="showSection('pos')"><i class="fa-solid fa-cash-register me-2"></i> ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (POS)</a>
                <a class="nav-link" onclick="showSection('history')"><i class="fa-solid fa-clock-rotate-left me-2"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</a>
                <a class="nav-link" onclick="showSection('purchase')"><i class="fa-solid fa-truck-ramp-box me-2"></i> ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</a>
                <a class="nav-link" onclick="showSection('products')"><i class="fa-solid fa-boxes-stacked me-2"></i> ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
                <a class="nav-link" onclick="showSection('settings')"><i class="fa-solid fa-gear me-2"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤/‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
            </nav>
        </div>

        <div class="col-md-10 offset-md-2 p-4">
            <div class="d-md-none mb-3 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold text-success"><i class="fa-solid fa-paw"></i> ‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó</h5>
                <button class="btn btn-green btn-sm" onclick="toggleMobileMenu()"><i class="fa-solid fa-bars"></i> ‡πÄ‡∏°‡∏ô‡∏π</button>
            </div>
            <div id="mobileMenu" class="d-md-none bg-white shadow p-3 rounded mb-3" style="display:none;">
                <a class="d-block p-2 text-dark text-decoration-none border-bottom" onclick="showSection('pos')">üõí ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</a>
                <a class="d-block p-2 text-dark text-decoration-none" onclick="showSection('dashboard')">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</a>
            </div>

            <div id="dashboard" class="section">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-0 text-secondary fw-bold"><i class="fa-solid fa-chart-line"></i> Dashboard</h3>
            <small class="text-muted">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="dashDate"></span></small>
        </div>
        <div>
             <button class="btn btn-sm btn-outline-secondary" onclick="renderDashboard()"><i class="fa-solid fa-rotate"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card card-custom p-3 border-start border-4 border-primary h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                        <h3 id="totalSales" class="fw-bold text-primary mb-0 mt-1">0 ‡∏ø</h3>
                    </div>
                    <div class="bg-primary bg-opacity-10 p-2 rounded text-primary">
                        <i class="fa-solid fa-wallet fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-custom p-3 border-start border-4 border-success h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Margin)</small>
                        <h3 id="netProfit" class="fw-bold text-success mb-0 mt-1">0 ‡∏ø</h3>
                        <small id="profitMargin" class="text-success fw-bold" style="font-size: 0.8rem;">(0%)</small>
                    </div>
                    <div class="bg-success bg-opacity-10 p-2 rounded text-success">
                        <i class="fa-solid fa-sack-dollar fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-custom p-3 border-start border-4 border-info h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏• / ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</small>
                        <h3 id="totalBills" class="fw-bold text-info mb-0 mt-1">0</h3>
                        <small id="avgBill" class="text-muted" style="font-size: 0.8rem;">Avg: 0 ‡∏ø</small>
                    </div>
                    <div class="bg-info bg-opacity-10 p-2 rounded text-info">
                        <i class="fa-solid fa-receipt fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-custom p-3 border-start border-4 border-warning h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</small>
                        <h3 id="totalStockValue" class="fw-bold text-warning mb-0 mt-1">0 ‡∏ø</h3>
                        <small class="text-muted" style="font-size: 0.8rem;">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏°</small>
                    </div>
                    <div class="bg-warning bg-opacity-10 p-2 rounded text-warning">
                        <i class="fa-solid fa-boxes-stacked fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card card-custom p-3 h-100">
                <h6 class="fw-bold text-secondary mb-3"><i class="fa-solid fa-crown text-warning"></i> 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</h6>
                <div style="height: 250px; position: relative;">
                    <canvas id="topProductChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card card-custom p-3 h-100">
                <h6 class="fw-bold text-secondary mb-3"><i class="fa-solid fa-clock text-primary"></i> ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Sales Traffic)</h6>
                <div style="height: 250px;">
                    <canvas id="hourlySalesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-8">
            <div class="card card-custom p-0 h-100">
                <div class="p-3 border-bottom bg-light">
                    <h6 class="fw-bold mb-0 text-secondary">üì¶ ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 text-center small">
                        <thead class="table-light text-muted">
                            <tr>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</th>
                                <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å)</th>
                                <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th>‡∏Å‡∏≥‡πÑ‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="recentTxTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-custom p-0 h-100">
                 <div class="p-3 border-bottom bg-light d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-danger">‚ö†Ô∏è ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h6>
                    <span class="badge bg-danger rounded-pill" id="lowStockCount">0</span>
                </div>
                <ul id="lowStockList" class="list-group list-group-flush small" style="max-height: 300px; overflow-y: auto;"></ul>
            </div>
        </div>
    </div>
</div>

            <div id="pos" class="section" style="display:none;">
                <div class="row h-100">
                    <div class="col-md-8">
                        <div class="d-flex gap-2 mb-3 align-items-center">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                                <input type="text" id="searchPos" class="form-control border-start-0 ps-0" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." onkeyup="renderPOS()">
                            </div>
                        </div>
                        <div class="row g-2" id="productGrid"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-custom p-0 h-100 d-flex flex-column shadow-sm">
                            <div class="p-3 bg-success text-white rounded-top d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fa-solid fa-basket-shopping"></i> ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</h5>
                                <span class="badge bg-white text-success" id="cartCount">0</span>
                            </div>
                            <div class="flex-grow-1 overflow-auto p-2" id="cartItems" style="background-color: #f8f9fa; max-height: 55vh;"></div>
                            <div class="p-3 border-top bg-white rounded-bottom">
                                <div class="d-flex justify-content-between align-items-end mb-2">
                                    <small class="text-muted">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</small>
                                    <h3 class="text-success fw-bold mb-0" id="cartTotal">0 ‡∏ø</h3>
                                </div>
                                <button class="btn btn-green w-100 py-3 fw-bold shadow-sm mb-2" onclick="checkout()">
                                    <i class="fa-solid fa-check-circle"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (F2)
                                </button>
                                <button class="btn btn-outline-danger w-100 btn-sm" onclick="clearCart()">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="purchase" class="section" style="display:none;">
                <h3 class="mb-4">üöö ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
                <div class="row">
                    <div class="col-md-5">
                        <div class="card card-custom p-4 mb-3">
                            <div class="mb-3">
                                <label class="form-label text-muted small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                                <select id="purchase-product" class="form-select" onchange="updatePurchaseUnitCost()"><option value="">-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option></select>
                            </div>
                            <div class="row mb-3">
                                <div class="col">
                                    <label class="form-label text-muted small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)</label>
                                    <input type="number" id="purchase-qty" class="form-control" placeholder="0">
                                </div>
                                <div class="col">
                                    <label class="form-label text-muted small">‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" id="purchase-cost" class="form-control" placeholder="0.00">
                                </div>
                            </div>
                            <button class="btn btn-green w-100" onclick="confirmPurchase()"><i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card card-custom p-4">
                            <h6 class="text-muted mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Å‡∏î‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm text-center align-middle">
                                    <thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                                    <tbody id="purchaseHistoryTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="products" class="section" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>üì¶ ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <button class="btn btn-green shadow-sm" onclick="openProductModal()"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                </div>
                <div class="card card-custom p-0 overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary small">
                                <tr><th class="ps-4">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</th><th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th class="text-end pe-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                            </thead>
                            <tbody id="stockTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settings" class="section" style="display:none;">
                <h3 class="mb-4">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card card-custom p-5 text-center h-100">
                            <i class="fa-solid fa-cloud-arrow-down fa-3x text-primary mb-3"></i>
                            <h4>‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)</h4>
                            <p class="text-muted small">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                            <button class="btn btn-outline-primary" onclick="exportData()">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå JSON</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card card-custom p-5 text-center h-100">
                            <i class="fa-solid fa-trash-can fa-3x text-danger mb-3"></i>
                            <h4>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                            <p class="text-muted small">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)</p>
                            <button class="btn btn-danger text-white" onclick="clearAllData()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="history" class="section" style="display:none;">
                <h3 class="mb-4">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                <div class="card card-custom p-3">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                            </thead>
                            <tbody id="historyTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="optionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="optionModalTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-2">
                <div id="optionList" class="d-grid gap-2"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Database ---
    let products = JSON.parse(localStorage.getItem('products_v6')) || [];
    let transactions = JSON.parse(localStorage.getItem('transactions_v6')) || [];
    let purchases = JSON.parse(localStorage.getItem('purchases_v6')) || [];
    let cart = [];

    // --- AUTO IMAGE ---
    function generateAvatar(text) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 200; canvas.height = 200;
        const colors = ['#f4a261', '#2a9d8f', '#e76f51', '#264653', '#e9c46a', '#8ecae6'];
        let hash = 0; for (let i=0; i<text.length; i++) hash = text.charCodeAt(i) + ((hash << 5) - hash);
        ctx.fillStyle = colors[Math.abs(hash) % colors.length];
        ctx.fillRect(0, 0, 200, 200);
        const initials = text ? text.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() : "?";
        ctx.fillStyle = 'white'; ctx.font = 'bold 100px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(initials, 100, 100);
        return canvas.toDataURL();
    }

    // --- Data Check ---
    let dataChanged = false;
    products.forEach(p => { if(!p.img || p.img === "" || p.img.includes('placehold.co')) { p.img = generateAvatar(p.name); dataChanged = true; } });
    if(dataChanged) localStorage.setItem('products_v6', JSON.stringify(products));

    // --- Navigation ---
    function showSection(id) {
        document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        event.target.closest('.nav-link')?.classList.add('active');
        document.getElementById('mobileMenu').style.display = 'none';
        
        if(id === 'pos') renderPOS();
        if(id === 'products') renderStock();
        if(id === 'history') renderHistory();
        if(id === 'purchase') renderPurchaseSection();
        if(id === 'dashboard') renderDashboard();
    }
    function toggleMobileMenu() {
        let m = document.getElementById('mobileMenu');
        m.style.display = m.style.display === 'none' ? 'block' : 'none';
    }
    function saveData() {
        localStorage.setItem('products_v6', JSON.stringify(products));
        localStorage.setItem('transactions_v6', JSON.stringify(transactions));
        localStorage.setItem('purchases_v6', JSON.stringify(purchases));
        renderDashboard();
    }

    // --- POS System ---
    function renderPOS() {
        const grid = document.getElementById('productGrid');
        const search = document.getElementById('searchPos').value.toLowerCase();
        grid.innerHTML = '';
        const filtered = products.filter(p => p.name.toLowerCase().includes(search));
        if(filtered.length === 0) { grid.innerHTML = '<div class="col-12 text-center text-muted py-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>'; return; }
        filtered.forEach(p => {
            let opacity = p.stock <= 0 ? 'opacity-50 grayscale' : '';
            let stockBadge = p.stock <= 0 ? '<span class="position-absolute top-50 start-50 translate-middle badge bg-danger shadow">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</span>' : `<span class="position-absolute top-0 end-0 m-2 badge bg-dark bg-opacity-75 text-white" style="font-size:0.8rem">${p.stock} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</span>`;
            let priceDisplay = '';
            if(p.options && p.options.length > 0) {
                let prices = p.options.map(o => o.price);
                priceDisplay = (Math.min(...prices) === Math.max(...prices)) ? `${prices[0]} ‡∏ø` : `${Math.min(...prices)} - ${Math.max(...prices)} ‡∏ø`;
            } else { priceDisplay = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤'; }
            grid.innerHTML += `
                <div class="col-6 col-md-4 col-lg-3" onclick="openOptionSelect(${p.id})">
                    <div class="card product-card h-100 ${opacity}">
                        <div class="position-relative">
                            <img src="${p.img}" class="product-img w-100">
                            ${stockBadge}
                        </div>
                        <div class="card-body p-2 text-center">
                            <h6 class="card-title text-truncate small mb-1 fw-bold">${p.name}</h6>
                            <p class="text-success fw-bold mb-0">${priceDisplay}</p>
                        </div>
                    </div>
                </div>`;
        });
        renderCart();
    }

    // --- MODAL & CART ---
    function openOptionSelect(id) {
        const p = products.find(x => x.id === id);
        if(!p || p.stock <= 0) return Swal.fire({ icon: 'error', title: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î!', timer: 1000, showConfirmButton: false });
        if (!p.options || p.options.length === 0) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢', 'warning');
        if (p.options.length === 1) { addToCart(p.id, 0); } 
        else {
            let optionsHtml = '<div class="d-grid gap-2">';
            p.options.forEach((opt, idx) => {
                optionsHtml += `<button class="btn btn-outline-success text-start d-flex justify-content-between p-3" onclick="swal.clickConfirm(); addToCart(${p.id}, ${idx})"><span>${opt.name} <small class="text-muted">(‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å ${opt.cutStock})</small></span><span class="fw-bold">${opt.price} ‡∏ø</span></button>`;
            });
            optionsHtml += '</div>';
            Swal.fire({ title: p.name, html: optionsHtml, showConfirmButton: false, showCloseButton: true });
        }
    }

    function addToCart(productId, optionIdx) {
        const p = products.find(x => x.id === productId);
        const opt = p.options[optionIdx];
        let inCartQty = 0;
        cart.forEach(c => { if(c.id === productId) inCartQty += (c.cutStock * c.qty); });
        if (p.stock < (inCartQty + opt.cutStock)) return Swal.fire({ icon: 'warning', title: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠', text: `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô` });
        const exist = cart.find(c => c.id === productId && c.optionName === opt.name);
        if(exist) exist.qty++;
        else cart.push({ id: p.id, name: p.name, optionName: opt.name, price: opt.price, cutStock: opt.cutStock, qty: 1 });
        renderCart();
        Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 }).fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß' });
    }

    function renderCart() {
        const div = document.getElementById('cartItems');
        if(cart.length === 0) {
            div.innerHTML = '<div class="text-center text-muted mt-5 opacity-50"><i class="fa-solid fa-basket-shopping fa-3x mb-3"></i><br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
            document.getElementById('cartTotal').innerText = '0 ‡∏ø';
            document.getElementById('cartCount').innerText = '0';
            return;
        }
        let html = '<ul class="list-group list-group-flush small">';
        let total = 0; let count = 0;
        cart.forEach((c, i) => {
            total += c.price * c.qty; count += c.qty;
            html += `<li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-1"><div class="text-truncate" style="max-width: 140px;"><span class="fw-bold">${c.name}</span><br><span class="badge bg-secondary text-white rounded-pill" style="font-size:0.7em">${c.optionName}</span> <span class="text-muted" style="font-size:0.8em">${c.price} x ${c.qty}</span></div><div class="d-flex align-items-center gap-2"><span class="fw-bold">${(c.price*c.qty).toLocaleString()}</span><i class="fa-solid fa-trash text-danger" style="cursor:pointer" onclick="cart.splice(${i},1);renderCart()"></i></div></li>`;
        });
        div.innerHTML = html + '</ul>';
        document.getElementById('cartTotal').innerText = total.toLocaleString() + ' ‡∏ø';
        document.getElementById('cartCount').innerText = count;
    }
    function clearCart() { cart = []; renderCart(); }

    // --- CHECKOUT ---
    function checkout() {
        if(cart.length === 0) return;
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
            html: `<h1 class="text-success fw-bold">${document.getElementById('cartTotal').innerText}</h1>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '‚úÖ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#2d6a4f'
        }).then((result) => { if (result.isConfirmed) processCheckout(); });
    }

    function processCheckout() {
        let totalCost = 0, totalSale = 0;
        cart.forEach(c => {
            let p = products.find(x => x.id === c.id);
            if(p) { 
                let deductAmount = c.cutStock * c.qty;
                p.stock -= deductAmount; 
                totalCost += (p.cost * deductAmount);
                totalSale += (c.price * c.qty);
            }
        });
        let billId = Date.now().toString().slice(-6);
        let txn = { id: billId, date: new Date().toLocaleString('th-TH'), items: [...cart], total: totalSale, profit: totalSale - totalCost };
        transactions.push(txn);
        saveData();
        cart = []; renderCart(); renderPOS();
        showDigitalBill(txn);
    }

    function showDigitalBill(txn) {
        let itemsHtml = '';
        txn.items.forEach(i => { itemsHtml += `<div class="bill-row"><span>${i.name} (${i.optionName}) x${i.qty}</span><span>${(i.price * i.qty).toLocaleString()}</span></div>`; });
        Swal.fire({
            html: `<div class="bill-wrapper"><div class="bill-header"><strong>‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó</strong><br>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà!<br>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${txn.date}<br>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•: ${txn.id}</div>${itemsHtml}<div class="bill-total"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span>${txn.total.toLocaleString()} ‡∏ø</span></div></div><div class="mt-3 text-center"><small class="text-muted">‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</small></div>`,
            showConfirmButton: true, confirmButtonText: '‡∏õ‡∏¥‡∏î', showDenyButton: true, denyButtonText: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', denyButtonColor: '#0d6efd'
        }).then((res) => {
            if(res.isDenied) {
                let textBill = `[‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î] ‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${txn.date}\n‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•: ${txn.id}\n------------------\n`;
                txn.items.forEach(i => { textBill += `${i.name} (${i.optionName}) x${i.qty} = ${(i.price*i.qty).toLocaleString()}\n`; });
                textBill += `------------------\n‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${txn.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!`;
                navigator.clipboard.writeText(textBill);
                Swal.fire('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
            }
        });
    }

    // --- History & Admin Delete ---
    function renderHistory() {
        const tbody = document.getElementById('historyTable');
        tbody.innerHTML = '';
        transactions.slice().reverse().slice(0, 50).forEach(t => {
            tbody.innerHTML += `
                <tr>
                    <td><small>${t.date}</small></td>
                    <td>${t.id}</td>
                    <td>${t.total.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick='showDigitalBill(${JSON.stringify(t)})'>‡∏î‡∏π‡∏ö‡∏¥‡∏•</button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteBill('${t.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    async function deleteBill(id) {
        const { value: password } = await Swal.fire({
            title: 'Admin Only',
            text: "‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏ö‡∏¥‡∏• (‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)",
            input: 'password',
            inputPlaceholder: 'Enter Password',
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#d33'
        });

        if (password === 'Gg6106') {
            const txnIndex = transactions.findIndex(t => t.id === id);
            if (txnIndex > -1) {
                const txn = transactions[txnIndex];
                txn.items.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) product.stock += (item.qty * item.cutStock);
                });
                transactions.splice(txnIndex, 1);
                saveData();
                renderHistory();
                Swal.fire('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        } else if (password) {
            Swal.fire('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î', '', 'error');
        }
    }

    // --- Purchase Management (NEW: Correction) ---
    function renderPurchaseSection() {
        const sel = document.getElementById('purchase-product');
        sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
        products.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
        
        const tbody = document.getElementById('purchaseHistoryTable');
        tbody.innerHTML = '';
        // Add index to allow deletion
        purchases.slice().reverse().slice(0,10).forEach((p, displayIdx) => {
            // Calculate real index in the main array
            let realIdx = purchases.length - 1 - displayIdx;
            
            tbody.innerHTML += `
                <tr>
                    <td>${p.date.split(' ')[0]}</td>
                    <td>${p.productName}</td>
                    <td class="text-success">+${p.qty}</td>
                    <td>${p.unitCost}</td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="deletePurchase(${realIdx})"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`;
        });
    }

    async function deletePurchase(index) {
        const { value: password } = await Swal.fire({
            title: 'Admin Only',
            text: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏ô‡∏µ‡πâ? (‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å)",
            input: 'password',
            inputPlaceholder: 'Enter Password',
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö',
            confirmButtonColor: '#d33'
        });

        if (password === 'Gg6106') {
            const p = purchases[index];
            // Find product to deduct stock
            const product = products.find(prod => prod.name === p.productName || prod.id === p.productId); // Try match by ID or Name
            
            if (product) {
                if (product.stock >= p.qty) {
                    product.stock -= p.qty;
                    purchases.splice(index, 1);
                    saveData();
                    renderPurchaseSection();
                    Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', `‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏≠‡∏Å ${p.qty} ‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                } else {
                    Swal.fire('‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', '‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏Ç‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)', 'error');
                }
            } else {
                // Product deleted? Just delete log
                purchases.splice(index, 1);
                saveData();
                renderPurchaseSection();
                Swal.fire('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            }
        } else if (password) {
            Swal.fire('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î', '', 'error');
        }
    }

    function updatePurchaseUnitCost() {
        let p = products.find(x => x.id == document.getElementById('purchase-product').value);
        if(p) document.getElementById('purchase-cost').value = p.cost;
    }
    function confirmPurchase() {
        let id = parseInt(document.getElementById('purchase-product').value);
        let qty = parseInt(document.getElementById('purchase-qty').value);
        let cost = parseFloat(document.getElementById('purchase-cost').value);
        if(!id || !qty || isNaN(cost)) return Swal.fire({icon:'error', title:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö'});
        let p = products.find(x => x.id === id);
        let oldVal = p.stock * p.cost;
        let newVal = qty * cost;
        p.stock += qty;
        p.cost = parseFloat(((oldVal + newVal) / p.stock).toFixed(2));
        // Add productId for safer referencing
        purchases.push({ date: new Date().toLocaleString('th-TH'), productName: p.name, productId: p.id, qty, unitCost: cost });
        saveData(); renderPurchaseSection();
        Swal.fire({icon:'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton:false});
        document.getElementById('purchase-qty').value = '';
    }

    // --- Product Logic ---
    async function openProductModal(id = null) {
        let p = id ? products.find(x => x.id === id) : { name: '', cost: '', stock: '', img: '', options: [] };
        if(!p.options) p.options = [];
        if(!p.img) p.img = generateAvatar(p.name || "?");

        const { value: formValues } = await Swal.fire({
            title: id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà',
            width: 600,
            html: `
                <div class="text-start font-sarabun">
                    <div class="text-center mb-3">
                        <img id="preview-img" src="${p.img}" class="rounded border shadow-sm" style="width: 100px; height: 100px; object-fit: cover;">
                        <br>
                        <label class="btn btn-sm btn-light mt-2 border">
                            <i class="fa-solid fa-camera"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ
                            <input type="file" id="swal-file" hidden accept="image/*" onchange="previewImage()">
                        </label>
                    </div>
                    <div class="mb-3"><label class="fw-bold small">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="swal-name" class="form-control" value="${p.name}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"></div>
                    <div class="row mb-3">
                        <div class="col"><label class="fw-bold small">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><input id="swal-cost" type="number" class="form-control" value="${p.cost}"></div>
                        <div class="col"><label class="fw-bold small text-success">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label><input id="swal-stock" type="number" class="form-control border-success" value="${p.stock}"></div>
                    </div>
                    <hr>
                    <label class="fw-bold small mb-2"><i class="fa-solid fa-tags"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ö‡∏ö)</label>
                    <div id="options-container">
                        ${p.options.map(opt => `<div class="input-group mb-2 option-row"><input type="text" class="form-control opt-name" value="${opt.name}"><input type="number" class="form-control opt-price" value="${opt.price}"><input type="number" class="form-control opt-cut" value="${opt.cutStock}"><button class="btn btn-outline-danger" onclick="this.parentElement.remove()">X</button></div>`).join('')}
                    </div>
                    <button class="btn btn-sm btn-outline-primary w-100 border-dashed" onclick="addOptionRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                </div>
            `,
            showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonColor: '#2d6a4f',
            preConfirm: () => {
                const newOptions = [];
                document.querySelectorAll('.option-row').forEach(row => {
                    const name = row.querySelector('.opt-name').value;
                    const price = parseInt(row.querySelector('.opt-price').value);
                    const cut = parseInt(row.querySelector('.opt-cut').value);
                    if(name && price && cut) newOptions.push({ name, price, cutStock: cut });
                });
                return {
                    name: document.getElementById('swal-name').value,
                    cost: parseFloat(document.getElementById('swal-cost').value) || 0,
                    stock: parseInt(document.getElementById('swal-stock').value) || 0,
                    imgSrc: document.getElementById('preview-img').src,
                    options: newOptions
                }
            }
        });

        if (formValues) {
            if (formValues.options.length === 0) return Swal.fire('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ö‡∏ö');
            if (id) Object.assign(p, { ...formValues, img: formValues.imgSrc });
            else products.push({ id: Date.now(), ...formValues, img: formValues.imgSrc });
            saveData(); renderStock(); renderPOS();
        }
    }
    
    window.addOptionRow = function() {
        const div = document.createElement('div');
        div.className = 'input-group mb-2 option-row';
        div.innerHTML = `<input type="text" class="form-control opt-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠"><input type="number" class="form-control opt-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤"><input type="number" class="form-control opt-cut" placeholder="‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å" value="1"><button class="btn btn-outline-danger" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('options-container').appendChild(div);
    }
    window.previewImage = function() {
        const file = document.getElementById('swal-file').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => document.getElementById('preview-img').src = e.target.result;
            reader.readAsDataURL(file);
        }
    }
    function deleteProduct(id) {
        Swal.fire({ title: '‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢' })
        .then((r) => { if(r.isConfirmed) { products = products.filter(p => p.id !== id); saveData(); renderStock(); renderPOS(); } });
    }
    function renderStock() {
        const tbody = document.getElementById('stockTable');
        tbody.innerHTML = '';
        products.forEach(p => {
            let optHtml = p.options ? p.options.map(o => `<span class="badge bg-light text-dark border me-1 mb-1">${o.name}: ${o.price}‡∏ö.</span>`).join(' ') : '<span class="text-danger">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤</span>';
            tbody.innerHTML += `<tr><td class="ps-4"><div class="d-flex align-items-center"><img src="${p.img}" class="rounded border" style="width:40px; height:40px; object-fit:cover; margin-right:10px;"><div class="text-truncate" style="max-width: 150px;"><strong>${p.name}</strong></div></div></td><td>${optHtml}</td><td>${p.cost}</td><td class="${p.stock<=5?'text-danger fw-bold':''}">${p.stock}</td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-secondary me-1" onclick="openProductModal(${p.id})"><i class="fa-solid fa-pen"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.id})"><i class="fa-solid fa-trash"></i></button></td></tr>`;
        });
    }

    // --- Settings & Utils ---
    function exportData() {
        const dataStr = JSON.stringify({ products, transactions, purchases });
        const link = document.createElement('a');
        link.href = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        link.download = 'wanyai_pos_v6_backup.json';
        link.click();
    }
    function clearAllData() {
        Swal.fire({title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?', text: "‡∏´‡∏≤‡∏¢‡∏´‡∏°‡∏î‡∏ô‡∏∞!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33'})
        .then((r) => { if(r.isConfirmed) { localStorage.clear(); location.reload(); } });
    }
    function renderDashboard() {
        let totalSales=0, netProfit=0, stockVal=0;
        transactions.forEach(t => { totalSales += t.total; netProfit += t.profit; });
        products.forEach(p => stockVal += (p.stock * p.cost));
        document.getElementById('totalSales').innerText = totalSales.toLocaleString() + ' ‡∏ø';
        document.getElementById('netProfit').innerText = netProfit.toLocaleString() + ' ‡∏ø';
        document.getElementById('totalStockValue').innerText = stockVal.toLocaleString() + ' ‡∏ø';
        const ctx = document.getElementById('salesChart').getContext('2d');
        if(window.salesChartInstance) window.salesChartInstance.destroy();
        let recent = transactions.slice().reverse().slice(0, 7).reverse();
        window.salesChartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: recent.map(t => t.date.split(' ')[1]), datasets: [{ label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢', data: recent.map(t => t.total), backgroundColor: '#2d6a4f', borderRadius: 5 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        let list = document.getElementById('lowStockList'); list.innerHTML = '';
        products.filter(p => p.stock <= 5).forEach(p => list.innerHTML += `<li class="list-group-item d-flex justify-content-between text-danger px-0"><span>${p.name}</span><strong>${p.stock}</strong></li>`);
    }

    renderDashboard();
</script>
</body>
</html>

