<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wan Yai Pet Mart POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet"> <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        :root {
            /* Palette ‡∏à‡∏≤‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ */
            --primary-color: #569e83;  /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤/‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô */
            --primary-dark: #3d7a62;   /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Hover */
            --secondary-color: #4a6fa5; /* ‡∏™‡∏µ‡∏Å‡∏£‡∏°‡∏ó‡πà‡∏≤‡∏à‡∏≤‡∏á‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Text ‡∏£‡∏≠‡∏á */
            --accent-color: #f4a261;   /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏≠‡∏∏‡πâ‡∏á‡πÄ‡∏ó‡πâ‡∏≤/‡πÄ‡∏û‡πá‡∏ó‡∏°‡∏≤‡∏£‡πå‡∏ó */
            --bg-color: #fdfbf7;       /* ‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÜ ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
            --card-shadow: 0 4px 20px rgba(86, 158, 131, 0.15); /* ‡πÄ‡∏á‡∏≤‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏à‡∏≤‡∏á‡πÜ */
        }
        
        body { 
            background-color: var(--bg-color); 
            font-family: 'Sarabun', sans-serif; 
            overflow-x: hidden;
            /* ‡∏™‡∏£‡πâ‡∏≤‡∏á Pattern ‡∏£‡∏≠‡∏¢‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏°‡∏ß‡∏î‡πâ‡∏ß‡∏¢ SVG inline */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 30c-1.5 0-2.8-1.2-2.8-2.8 0-1.5 1.2-2.8 2.8-2.8 1.5 0 2.8 1.2 2.8 2.8 0 1.5-1.2 2.8-2.8 2.8zm0-8c-1.5 0-2.8-1.2-2.8-2.8 0-1.5 1.2-2.8 2.8-2.8 1.5 0 2.8 1.2 2.8 2.8 0 1.5-1.2 2.8-2.8 2.8zm-6 5c-1.5 0-2.8-1.2-2.8-2.8 0-1.5 1.2-2.8 2.8-2.8 1.5 0 2.8 1.2 2.8 2.8 0 1.5-1.2 2.8-2.8 2.8zm12 0c-1.5 0-2.8-1.2-2.8-2.8 0-1.5 1.2-2.8 2.8-2.8 1.5 0 2.8 1.2 2.8 2.8 0 1.5-1.2 2.8-2.8 2.8zm-6 12c-3.3 0-6-2.7-6-6 0-1 .3-1.9.8-2.7.5-.7 1.2-1.2 2-1.5 1-.4 2.1-.6 3.2-.6 1.1 0 2.2.2 3.2.6.8.3 1.5.8 2 1.5.5.8.8 1.7.8 2.7 0 3.3-2.7 6-6 6z' fill='%23569e83' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        h1, h2, h3, h4, h5, h6, .brand-font {
            font-family: 'Fredoka', 'Sarabun', sans-serif; /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Ç‡∏∂‡πâ‡∏ô */
        }
        
        /* Sidebar */
        .sidebar { 
            min-height: 100vh; 
            background-color: rgba(255, 255, 255, 0.95); /* ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏•‡∏≤‡∏¢ */
            border-right: 1px solid #e9ecef; 
            position: fixed; 
            width: 250px; 
            z-index: 1000; 
            transition: 0.3s; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        .sidebar-header { padding: 25px; border-bottom: 2px dashed #e9ecef; }
        .nav-link { color: #6c757d; padding: 12px 20px; margin: 6px 15px; border-radius: 20px; transition: 0.2s; font-weight: 500; }
        .nav-link:hover { background-color: #ebf5f0; color: var(--primary-color); }
        .nav-link.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(86, 158, 131, 0.3); }
        .nav-link i { width: 25px; text-align: center; margin-right: 10px; }
        
        /* Main Content */
        .main-content { margin-left: 250px; padding: 30px; transition: 0.3s; }
        .section-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Cards */
        .card-custom { 
            border: none; 
            border-radius: 16px; 
            box-shadow: var(--card-shadow); 
            background: white; 
            transition: 0.2s; 
            position: relative;
            overflow: hidden;
        }
        .card-custom::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            opacity: 0.8;
        }
        .card-custom:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(86, 158, 131, 0.2); }
        
        /* Product Grid */
        .product-card { 
            cursor: pointer; 
            transition: 0.2s; 
            border: 2px solid #f0f0f0; 
            overflow: hidden; 
            border-radius: 12px; 
            background: white;
        }
        .product-card:hover { border-color: var(--accent-color); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(244, 162, 97, 0.2); }
        .product-img { height: 140px; object-fit: cover; width: 100%; background-color: #f8f9fa; }
        
        /* Buttons */
        .btn-theme { 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 10px;
        }
        .btn-theme:hover { background-color: var(--primary-dark); color: white; }
        
        /* Badge Colors Override */
        .text-primary { color: var(--primary-color) !important; }
        .bg-primary { background-color: var(--primary-color) !important; }
        .border-primary { border-color: var(--primary-color) !important; }
        
        .text-warning { color: var(--accent-color) !important; }
        .bg-warning { background-color: var(--accent-color) !important; }
        .border-warning { border-color: var(--accent-color) !important; }

        /* Utils */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }
        
        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 280px; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
            .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
            .mobile-overlay.active { display: block; }
        }
    </style>
</head>
<body>

<div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>
<div class="sidebar d-flex flex-column" id="sidebar">
    <div class="sidebar-header d-flex align-items-center gap-3">
        <div class="bg-white border border-2 border-success text-warning rounded-circle d-flex justify-content-center align-items-center shadow-sm" style="width: 55px; height: 55px; border-color: var(--primary-color)!important; color: var(--accent-color)!important;">
            <i class="fa-solid fa-paw fa-2x"></i>
        </div>
        <div style="line-height: 1.1;">
            <h5 class="fw-bold mb-0" style="color: var(--primary-color);">‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà</h5>
            <h6 class="fw-bold mb-0" style="color: var(--accent-color);">‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó</h6>
        </div>
    </div>
    
    <nav class="nav flex-column mt-3 flex-grow-1">
        <a class="nav-link active" onclick="showSection('dashboard')"><i class="fa-solid fa-chart-pie"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a>
        <a class="nav-link" onclick="showSection('pos')"><i class="fa-solid fa-cash-register"></i> ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</a>
        <a class="nav-link" onclick="showSection('products')"><i class="fa-solid fa-boxes-stacked"></i> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏™‡∏ï‡πä‡∏≠‡∏Å</a>
        <a class="nav-link" onclick="showSection('history')"><i class="fa-solid fa-clock-rotate-left"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≤‡∏¢</a>
        <a class="nav-link" onclick="showSection('purchase')"><i class="fa-solid fa-truck-ramp-box"></i> ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤</a>
    </nav>

    <div class="p-3 border-top text-center">
        <small class="text-muted d-block mb-2">Wan Yai Pet Mart V.7.1</small>
        <a class="btn btn-sm btn-outline-secondary w-100" onclick="showSection('settings')"><i class="fa-solid fa-gear"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</a>
    </div>
</div>

<div class="main-content">
    <div class="d-md-none d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-white shadow-sm text-success" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        <span class="fw-bold text-success">‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó</span>
        <div style="width: 40px;"></div>
    </div>

    <div id="dashboard" class="section">
        <div class="section-header">
            <div>
                <h4 class="fw-bold mb-0 text-dark">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</h4>
                <small class="text-muted">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="dashDate"></span></small>
            </div>
            <button class="btn btn-white bg-white border shadow-sm text-success" onclick="renderDashboard()"><i class="fa-solid fa-rotate-right"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-6 col-lg-3">
                <div class="card card-custom p-3 h-100 border-start border-0">
                    <div class="d-flex justify-content-between">
                        <div>
                            <small class="text-muted fw-bold">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                            <h3 id="totalSales" class="fw-bold text-primary my-1">0 ‡∏ø</h3>
                        </div>
                        <div class="text-primary bg-light rounded-circle d-flex align-items-center justify-content-center" style="width:50px; height:50px;">
                             <i class="fa-solid fa-wallet fa-lg"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-muted small"><i class="fa-solid fa-receipt"></i> <span id="totalBills">0</span> ‡∏ö‡∏¥‡∏•</div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card card-custom p-3 h-100 border-start border-0">
                    <div class="d-flex justify-content-between">
                        <div>
                            <small class="text-muted fw-bold">‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô (Est.)</small>
                            <h3 id="netProfit" class="fw-bold text-success my-1">0 ‡∏ø</h3>
                        </div>
                        <div class="text-success bg-light rounded-circle d-flex align-items-center justify-content-center" style="width:50px; height:50px;">
                             <i class="fa-solid fa-sack-dollar fa-lg"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-muted small">Margin: <span id="profitMargin" class="text-success fw-bold">0%</span></div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card card-custom p-3 h-100 border-start border-0">
                    <div class="d-flex justify-content-between">
                        <div>
                            <small class="text-muted fw-bold">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏£‡∏ß‡∏°</small>
                            <h3 id="totalStockValue" class="fw-bold text-warning my-1">0 ‡∏ø</h3>
                        </div>
                        <div class="text-warning bg-light rounded-circle d-flex align-items-center justify-content-center" style="width:50px; height:50px;">
                             <i class="fa-solid fa-boxes-stacked fa-lg"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-muted small">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏°‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô</div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card card-custom p-3 h-100 border-start border-0">
                    <div class="d-flex justify-content-between">
                        <div>
                            <small class="text-muted fw-bold">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°</small>
                            <h3 id="lowStockCount" class="fw-bold text-danger my-1">0</h3>
                        </div>
                        <div class="text-danger bg-light rounded-circle d-flex align-items-center justify-content-center" style="width:50px; height:50px;">
                             <i class="fa-solid fa-triangle-exclamation fa-lg"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-muted small">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå</div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-lg-8">
                <div class="card card-custom p-4 h-100">
                    <h6 class="fw-bold text-secondary mb-3"><i class="fa-solid fa-clock"></i> ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Sales Traffic)</h6>
                    <div style="height: 300px;"><canvas id="hourlySalesChart"></canvas></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h6 class="fw-bold text-secondary mb-3"><i class="fa-solid fa-crown text-warning"></i> 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</h6>
                    <div style="height: 250px;"><canvas id="topProductChart"></canvas></div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-lg-8">
                <div class="card card-custom p-0 h-100">
                    <div class="p-3 border-bottom bg-white"><h6 class="fw-bold mb-0">üìù ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h6></div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center small">
                            <thead class="bg-light text-secondary"><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                            <tbody id="recentTxTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card card-custom p-0 h-100">
                    <div class="p-3 border-bottom bg-white d-flex justify-content-between"><h6 class="fw-bold mb-0 text-danger">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</h6></div>
                    <ul id="lowStockList" class="list-group list-group-flush small" style="max-height: 300px; overflow-y: auto;"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="pos" class="section" style="display:none;">
        <div class="row h-100 g-3">
            <div class="col-lg-8 d-flex flex-column h-100">
                <div class="card card-custom p-3 mb-3">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                        <input type="text" id="searchPos" class="form-control border-start-0 shadow-none" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠/‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î)..." onkeyup="renderPOS()">
                    </div>
                </div>
                <div class="flex-grow-1 overflow-auto pe-1" style="max-height: 80vh;">
                    <div class="row g-2" id="productGrid"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card card-custom h-100 d-flex flex-column shadow-lg" style="border: 2px solid var(--primary-color);">
                    <div class="p-3 text-white rounded-top d-flex justify-content-between align-items-center" style="background-color: var(--primary-color);">
                        <h5 class="mb-0"><i class="fa-solid fa-basket-shopping"></i> ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</h5>
                        <span class="badge bg-white text-success fw-bold" id="cartCount">0</span>
                    </div>
                    <div class="flex-grow-1 overflow-auto p-2" id="cartItems" style="background-color: #fffdf9;"></div>
                    <div class="p-3 border-top bg-white rounded-bottom">
                        <div class="d-flex justify-content-between align-items-end mb-3">
                            <span class="text-muted">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                            <h2 class="text-success fw-bold mb-0" id="cartTotal">0 ‡∏ø</h2>
                        </div>
                        <button class="btn w-100 py-3 fw-bold fs-5 shadow-sm mb-2 text-white" style="background-color: var(--accent-color); border:none;" onclick="checkout()">
                            <i class="fa-regular fa-credit-card"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (F2)
                        </button>
                        <button class="btn btn-outline-secondary w-100 btn-sm" onclick="clearCart()">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="products" class="section" style="display:none;">
        <div class="section-header">
            <h4 class="fw-bold text-dark">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
            <button class="btn btn-theme shadow-sm" onclick="openProductModal()"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>
        <div class="card card-custom p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary small">
                        <tr><th class="ps-4">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th><th>‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th class="text-end pe-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                    </thead>
                    <tbody id="stockTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="history" class="section" style="display:none;">
        <div class="section-header">
            <h4 class="fw-bold text-dark">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h4>
            <div></div>
        </div>
        <div class="card card-custom p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light"><tr><th class="ps-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th class="text-end pe-4">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th></tr></thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="purchase" class="section" style="display:none;">
        <h4 class="fw-bold mb-4 text-dark">‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å</h4>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card card-custom p-4">
                    <label class="form-label text-muted small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select id="purchase-product" class="form-select mb-3" onchange="updatePurchaseUnitCost()"><option value="">-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option></select>
                    
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label text-muted small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)</label>
                            <input type="number" id="purchase-qty" class="form-control" placeholder="0">
                        </div>
                        <div class="col">
                            <label class="form-label text-muted small">‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                            <input type="number" id="purchase-cost" class="form-control" placeholder="0.00">
                        </div>
                    </div>
                    <button class="btn btn-theme w-100" onclick="confirmPurchase()"><i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</button>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card card-custom p-4">
                    <h6 class="text-muted mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                    <div class="table-responsive">
                        <table class="table table-sm text-center align-middle">
                            <thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏•‡∏ö</th></tr></thead>
                            <tbody id="purchaseHistoryTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settings" class="section" style="display:none;">
        <div class="container-fluid p-0">
            <h4 class="fw-bold mb-4 text-dark">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card card-custom p-4 text-center h-100">
                        <div class="text-primary mb-3"><i class="fa-solid fa-cloud-arrow-down fa-3x"></i></div>
                        <h5>‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)</h5>
                        <p class="text-muted small">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå JSON</p>
                        <button class="btn btn-outline-primary w-100 mt-auto" onclick="exportData()">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-custom p-4 text-center h-100">
                        <div class="text-success mb-3"><i class="fa-solid fa-cloud-arrow-up fa-3x"></i></div>
                        <h5>‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)</h5>
                        <p class="text-muted small">‡∏ô‡∏≥‡πÑ‡∏ü‡∏•‡πå JSON ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢ Backup ‡πÑ‡∏ß‡πâ ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
                        <button class="btn btn-outline-success w-100 mt-auto" onclick="document.getElementById('importFile').click()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-custom p-4 text-center h-100">
                        <div class="text-danger mb-3"><i class="fa-solid fa-triangle-exclamation fa-3x"></i></div>
                        <h5>‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Reset)</h5>
                        <p class="text-muted small">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
                        <button class="btn btn-outline-danger w-100 mt-auto" onclick="clearAllData()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- Global Data & State ---
    let products = JSON.parse(localStorage.getItem('products_v7')) || [];
    let transactions = JSON.parse(localStorage.getItem('transactions_v7')) || [];
    let purchases = JSON.parse(localStorage.getItem('purchases_v7')) || [];
    let cart = [];
    let topProductChartInstance = null;
    let hourlyChartInstance = null;

    // --- Auto Avatar Generator (Updated Colors) ---
    function generateAvatar(text) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 200; canvas.height = 200;
        // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏à‡∏≤‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ
        const colors = ['#569e83', '#f4a261', '#4a6fa5', '#88b7a2', '#f7c59f'];
        let hash = 0; for (let i=0; i<text.length; i++) hash = text.charCodeAt(i) + ((hash << 5) - hash);
        ctx.fillStyle = colors[Math.abs(hash) % colors.length];
        ctx.fillRect(0, 0, 200, 200);
        ctx.fillStyle = 'white'; ctx.font = 'bold 100px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(text ? text.charAt(0).toUpperCase() : "?", 100, 100);
        return canvas.toDataURL();
    }

    // --- Navigation & Sidebar ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('mobileOverlay').classList.toggle('active');
    }
    function showSection(id) {
        document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        const links = document.querySelectorAll('.nav-link');
        if(id === 'dashboard') links[0].classList.add('active');
        if(id === 'pos') { links[1].classList.add('active'); renderPOS(); }
        if(id === 'products') { links[2].classList.add('active'); renderStock(); }
        if(id === 'history') { links[3].classList.add('active'); renderHistory(); }
        if(id === 'purchase') { links[4].classList.add('active'); renderPurchaseSection(); }
        if(id === 'settings') links[5].classList.add('active');
        
        if(window.innerWidth < 768) toggleSidebar();
        if(id === 'dashboard') renderDashboard();
    }
    function saveData() {
        localStorage.setItem('products_v7', JSON.stringify(products));
        localStorage.setItem('transactions_v7', JSON.stringify(transactions));
        localStorage.setItem('purchases_v7', JSON.stringify(purchases));
    }

    // --- 1. DASHBOARD LOGIC (Updated Colors) ---
    function renderDashboard() {
        const today = new Date();
        const dateStr = today.toLocaleDateString('th-TH');
        const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
        const todayEnd = todayStart + 86400000;
        
        document.getElementById('dashDate').innerText = dateStr;

        const todayTxs = transactions.filter(t => {
            if(t.timestamp) return t.timestamp >= todayStart && t.timestamp < todayEnd;
            return t.date.startsWith(dateStr.split('/')[0] + '/'); 
        });

        let totalSales = 0, totalProfit = 0;
        todayTxs.forEach(t => { totalSales += t.total; totalProfit += t.profit; });
        
        let stockVal = 0, lowStock = [];
        products.forEach(p => { 
            stockVal += (p.stock * p.cost);
            if(p.stock <= 5) lowStock.push(p);
        });

        document.getElementById('totalSales').innerText = totalSales.toLocaleString() + ' ‡∏ø';
        document.getElementById('netProfit').innerText = totalProfit.toLocaleString() + ' ‡∏ø';
        document.getElementById('totalBills').innerText = todayTxs.length;
        document.getElementById('profitMargin').innerText = totalSales > 0 ? ((totalProfit/totalSales)*100).toFixed(1) + '%' : '0%';
        document.getElementById('totalStockValue').innerText = stockVal.toLocaleString() + ' ‡∏ø';
        document.getElementById('lowStockCount').innerText = lowStock.length;

        // Chart 1: Hourly Sales
        let hourlyData = new Array(24).fill(0);
        todayTxs.forEach(t => {
            let hour = 0;
            if(t.timestamp) { hour = new Date(t.timestamp).getHours(); } 
            else { try { hour = parseInt(t.date.split(' ')[1].split(':')[0]); } catch(e){} }
            if(hour >= 0 && hour < 24) hourlyData[hour] += t.total;
        });
        
        const ctxHourly = document.getElementById('hourlySalesChart').getContext('2d');
        if(hourlyChartInstance) hourlyChartInstance.destroy();
        hourlyChartInstance = new Chart(ctxHourly, {
            type: 'line',
            data: {
                labels: Array.from({length:17}, (_,i)=> (i+6)+":00"),
                datasets: [{
                    label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                    data: hourlyData.slice(6, 23),
                    borderColor: '#569e83', // Green Primary
                    backgroundColor: 'rgba(86, 158, 131, 0.1)',
                    fill: true, tension: 0.4, pointBackgroundColor: '#f4a261' // Accent dot
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
        });

        // Chart 2: Top Products
        let productMap = {};
        transactions.forEach(t => {
            t.items.forEach(i => {
                if(!productMap[i.name]) productMap[i.name] = 0;
                productMap[i.name] += i.qty;
            });
        });
        let sortedProd = Object.keys(productMap).map(key => ({name: key, qty: productMap[key]})).sort((a,b)=>b.qty - a.qty).slice(0,5);
        
        const ctxTop = document.getElementById('topProductChart').getContext('2d');
        if(topProductChartInstance) topProductChartInstance.destroy();
        topProductChartInstance = new Chart(ctxTop, {
            type: 'doughnut',
            data: {
                labels: sortedProd.map(x=>x.name),
                datasets: [{
                    data: sortedProd.map(x=>x.qty),
                    // Palette: Green, Orange, Blue, Light Green, Light Orange
                    backgroundColor: ['#569e83', '#f4a261', '#4a6fa5', '#88b7a2', '#f7c59f'],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'right', labels:{boxWidth:12}} } }
        });

        const recentBody = document.getElementById('recentTxTable');
        recentBody.innerHTML = '';
        todayTxs.slice().reverse().slice(0, 10).forEach(t => {
            let itemStr = t.items[0] ? t.items[0].name + (t.items.length>1 ? ` (+${t.items.length-1})`:'') : '-';
            recentBody.innerHTML += `<tr><td>${t.date.split(' ')[1]}</td><td><span class="badge bg-light text-dark border">${t.id}</span></td><td class="text-start">${itemStr}</td><td class="fw-bold text-success">${t.total.toLocaleString()}</td><td><i class="fa-solid fa-circle-check text-success"></i></td></tr>`;
        });
        if(todayTxs.length === 0) recentBody.innerHTML = '<tr><td colspan="5" class="text-muted py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';

        const list = document.getElementById('lowStockList');
        list.innerHTML = '';
        lowStock.forEach(p => {
            list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><div class="d-flex align-items-center"><img src="${p.img}" class="rounded me-2" style="width:30px;height:30px;"><span>${p.name}</span></div><span class="badge bg-danger rounded-pill">${p.stock}</span></li>`;
        });
        if(lowStock.length===0) list.innerHTML = '<li class="list-group-item text-center text-success border-0"><i class="fa-solid fa-check-circle"></i> ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥</li>';
    }

    // --- 2. POS SYSTEM ---
    function renderPOS() {
        const grid = document.getElementById('productGrid');
        const term = document.getElementById('searchPos').value.toLowerCase();
        grid.innerHTML = '';
        const filtered = products.filter(p => p.name.toLowerCase().includes(term));
        
        if(filtered.length === 0) { grid.innerHTML = '<div class="col-12 text-center text-muted py-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>'; return; }
        
        filtered.forEach(p => {
            let isOut = p.stock <= 0;
            let priceTxt = (p.options && p.options.length) ? Math.min(...p.options.map(o=>o.price)) + "‡∏ø+" : "N/A";
            grid.innerHTML += `
            <div class="col-6 col-md-4 col-lg-3" onclick="selectProduct(${p.id})">
                <div class="card product-card h-100 ${isOut ? 'opacity-50 grayscale' : ''}">
                    <div class="position-relative">
                        <img src="${p.img}" class="product-img">
                        <span class="position-absolute top-0 end-0 m-2 badge ${isOut?'bg-danger':'bg-success'} shadow">${p.stock}</span>
                    </div>
                    <div class="card-body p-2 text-center">
                        <small class="fw-bold d-block text-truncate text-dark">${p.name}</small>
                        <span class="text-warning fw-bold">${priceTxt}</span>
                    </div>
                </div>
            </div>`;
        });
    }

    function selectProduct(id) {
        const p = products.find(x => x.id === id);
        if(!p || p.stock <= 0) return Swal.fire({icon:'error', title:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î', timer:1000, showConfirmButton:false});
        
        if(p.options.length > 1) {
            let html = '<div class="d-grid gap-2">';
            p.options.forEach((o, i) => {
                html += `<button class="btn btn-outline-success d-flex justify-content-between py-2" onclick="addToCart(${p.id}, ${i}); Swal.close()"><span>${o.name}</span><b>${o.price}‡∏ø</b></button>`;
            });
            Swal.fire({ title: p.name, html: html+'</div>', showConfirmButton: false, confirmButtonColor: '#569e83' });
        } else {
            addToCart(p.id, 0);
        }
    }

    function addToCart(pid, optIdx) {
        const p = products.find(x => x.id === pid);
        const opt = p.options[optIdx];
        const currentInCart = cart.reduce((acc, c) => (c.id === pid ? acc + (c.qty * c.cutStock) : acc), 0);
        
        if(p.stock < (currentInCart + opt.cutStock)) return Swal.fire({toast:true, position:'top-end', icon:'warning', title:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠', timer:1500});
        
        const exist = cart.find(c => c.id === pid && c.optionName === opt.name);
        if(exist) exist.qty++;
        else cart.push({ id: p.id, name: p.name, optionName: opt.name, price: opt.price, cutStock: opt.cutStock, qty: 1 });
        
        renderCart();
    }

    function renderCart() {
        const div = document.getElementById('cartItems');
        let total = 0, count = 0;
        let html = '<ul class="list-group list-group-flush small">';
        cart.forEach((c, i) => {
            total += c.price * c.qty; count += c.qty;
            html += `
            <li class="list-group-item d-flex justify-content-between align-items-center px-1 bg-transparent">
                <div class="text-truncate" style="max-width: 130px;">
                    <span class="fw-bold text-dark">${c.name}</span><br>
                    <span class="text-muted" style="font-size:0.8em">${c.optionName} (${c.price}x${c.qty})</span>
                </div>
                <div>
                    <span class="fw-bold me-2 text-dark">${(c.price*c.qty).toLocaleString()}</span>
                    <i class="fa-solid fa-trash text-danger" style="cursor:pointer" onclick="cart.splice(${i},1);renderCart()"></i>
                </div>
            </li>`;
        });
        div.innerHTML = cart.length ? html+'</ul>' : '<div class="text-center text-muted mt-5 opacity-50"><i class="fa-solid fa-basket-shopping fa-3x"></i><br>‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>';
        document.getElementById('cartTotal').innerText = total.toLocaleString() + ' ‡∏ø';
        document.getElementById('cartCount').innerText = count;
    }

    function checkout() {
        if(cart.length === 0) return;
        const total = cart.reduce((sum, c) => sum + (c.price * c.qty), 0);
        Swal.fire({
            title: '‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
            html: `<h1 class="text-success fw-bold">${total.toLocaleString()}</h1>`,
            showCancelButton: true, confirmButtonText: '‚úÖ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô', confirmButtonColor: '#f4a261', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((res) => {
            if(res.isConfirmed) processTransaction(total);
        });
    }

    function processTransaction(saleTotal) {
        let costTotal = 0;
        cart.forEach(c => {
            let p = products.find(x => x.id === c.id);
            if(p) {
                let cut = c.cutStock * c.qty;
                p.stock -= cut;
                costTotal += (p.cost * cut);
            }
        });
        
        const tx = {
            id: Date.now().toString().slice(-6),
            timestamp: Date.now(), 
            date: new Date().toLocaleString('th-TH'),
            items: [...cart],
            total: saleTotal,
            profit: saleTotal - costTotal
        };
        
        transactions.push(tx);
        saveData();
        cart = []; renderCart(); renderPOS(); renderDashboard();
        
        let slip = `[‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î] ‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏û‡πá‡∏ó ‡∏°‡∏≤‡∏£‡πå‡∏ó\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${tx.date}\n----------------\n`;
        tx.items.forEach(i => slip += `${i.name} (${i.qty}) = ${i.price*i.qty}\n`);
        slip += `----------------\n‡∏£‡∏ß‡∏°: ${tx.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
        
        Swal.fire({
            icon: 'success', title: '‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 
            html: '<small class="text-muted">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</small>',
            confirmButtonText: '‡∏õ‡∏¥‡∏î', showDenyButton: true, denyButtonText: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ö‡∏¥‡∏•', confirmButtonColor: '#569e83', denyButtonColor: '#4a6fa5'
        }).then((r) => {
            if(r.isDenied) { navigator.clipboard.writeText(slip); Swal.fire('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß','','success'); }
        });
    }
    function clearCart() { cart=[]; renderCart(); }

    // --- 3. PRODUCT MGMT ---
    async function openProductModal(id = null) {
        const p = id ? products.find(x=>x.id===id) : { name:'', cost:0, stock:0, img:'', options:[{name:'‡∏õ‡∏Å‡∏ï‡∏¥', price:0, cutStock:1}] };
        if(!p.img) p.img = generateAvatar(p.name||"?");
        
        let optHtml = p.options.map(o => `
            <div class="input-group mb-2 opt-row">
                <input type="text" class="form-control opt-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô" value="${o.name}">
                <input type="number" class="form-control opt-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢" value="${o.price}">
                <input type="number" class="form-control opt-cut" placeholder="‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å" value="${o.cutStock}">
                <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">X</button>
            </div>`).join('');

        const { value: form } = await Swal.fire({
            title: id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà',
            width: 600,
            html: `
                <div class="text-start">
                    <div class="text-center mb-3">
                        <img id="prev-img" src="${p.img}" class="rounded shadow-sm border" style="width:100px;height:100px;object-fit:cover;">
                        <div class="mt-2"><label class="btn btn-sm btn-light border">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ <input type="file" hidden onchange="document.getElementById('prev-img').src = window.URL.createObjectURL(this.files[0])"></label></div>
                    </div>
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="swal-name" class="form-control mb-2" value="${p.name}">
                    <div class="row mb-2">
                        <div class="col"><label>‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</label><input type="number" id="swal-cost" class="form-control" value="${p.cost}"></div>
                        <div class="col"><label>‡∏™‡∏ï‡πä‡∏≠‡∏Å</label><input type="number" id="swal-stock" class="form-control" value="${p.stock}"></div>
                    </div>
                    <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏Ñ‡∏≤)</label>
                    <div id="opt-container">${optHtml}</div>
                    <button type="button" class="btn btn-sm w-100 mt-2 text-white" style="background-color: var(--secondary-color);" onclick="addOptRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</button>
                </div>
            `,
            confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', showCancelButton: true, confirmButtonColor: '#569e83',
            preConfirm: () => {
                const opts = [];
                document.querySelectorAll('.opt-row').forEach(row => {
                    opts.push({
                        name: row.querySelector('.opt-name').value,
                        price: Number(row.querySelector('.opt-price').value),
                        cutStock: Number(row.querySelector('.opt-cut').value)
                    });
                });
                return {
                    name: document.getElementById('swal-name').value,
                    cost: Number(document.getElementById('swal-cost').value),
                    stock: Number(document.getElementById('swal-stock').value),
                    img: document.getElementById('prev-img').src,
                    options: opts
                };
            }
        });

        if(form) {
            if(id) { const idx = products.findIndex(x=>x.id===id); products[idx] = {id, ...form}; }
            else { products.push({id:Date.now(), ...form}); }
            saveData(); renderStock(); renderPOS(); renderDashboard();
        }
    }

    window.addOptRow = function() {
        const div = document.createElement('div');
        div.className = 'input-group mb-2 opt-row';
        div.innerHTML = `<input class="form-control opt-name" value="‡∏õ‡∏Å‡∏ï‡∏¥"><input type="number" class="form-control opt-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤"><input type="number" class="form-control opt-cut" value="1"><button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('opt-container').appendChild(div);
    };

    function renderStock() {
        const tb = document.getElementById('stockTable'); tb.innerHTML = '';
        products.forEach(p => {
            let price = p.options.map(o=>o.price).join('/');
            tb.innerHTML += `<tr><td class="ps-4"><div class="d-flex align-items-center"><img src="${p.img}" style="width:40px;height:40px;object-fit:cover;" class="rounded border me-2"><span>${p.name}</span></div></td><td>${price}</td><td>${p.cost}</td><td class="${p.stock<=5?'text-danger fw-bold':''}">${p.stock}</td><td class="text-end pe-4"><button class="btn btn-sm btn-light border" onclick="openProductModal(${p.id})"><i class="fa-solid fa-pen"></i></button> <button class="btn btn-sm btn-light border text-danger" onclick="delProd(${p.id})"><i class="fa-solid fa-trash"></i></button></td></tr>`;
        });
    }
    function delProd(id) { Swal.fire({title:'‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed){products=products.filter(x=>x.id!==id);saveData();renderStock();renderPOS();}}) }

    // --- 4. HISTORY ---
    function renderHistory() {
        const tb = document.getElementById('historyTable'); tb.innerHTML = '';
        transactions.slice().reverse().slice(0,50).forEach(t => {
            tb.innerHTML += `<tr><td class="ps-4">${t.date}</td><td>${t.id}</td><td>${t.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td><td class="fw-bold text-success">${t.total.toLocaleString()}</td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-danger" onclick="delBill('${t.id}')">‡∏•‡∏ö</button></td></tr>`;
        });
    }
    async function delBill(id) {
        const {value:pass} = await Swal.fire({title:'Admin Password', input:'password'});
        if(pass === 'admin') { 
            const idx = transactions.findIndex(x=>x.id===id);
            if(idx > -1) {
                transactions[idx].items.forEach(i => {
                    let p = products.find(x=>x.id===i.id);
                    if(p) p.stock += (i.qty * i.cutStock);
                });
                transactions.splice(idx,1); saveData(); renderHistory(); renderDashboard();
                Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß','‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
            }
        } else if(pass) Swal.fire('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î','','error');
    }

    // --- 5. PURCHASE ---
    function renderPurchaseSection() {
        const sel = document.getElementById('purchase-product');
        sel.innerHTML = '<option value="">-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
        products.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
        
        const tb = document.getElementById('purchaseHistoryTable'); tb.innerHTML = '';
        purchases.slice().reverse().slice(0,10).forEach((p, i) => {
            tb.innerHTML += `<tr><td>${p.date.split(' ')[0]}</td><td>${p.productName}</td><td class="text-success">+${p.qty}</td><td>${p.unitCost}</td><td><button class="btn btn-sm btn-light text-danger" onclick="delPurchase(${purchases.length-1-i})"><i class="fa-solid fa-trash"></i></button></td></tr>`;
        });
    }
    function updatePurchaseUnitCost() {
        let id = document.getElementById('purchase-product').value;
        let p = products.find(x=>x.id==id);
        if(p) document.getElementById('purchase-cost').value = p.cost;
    }
    function confirmPurchase() {
        let id = Number(document.getElementById('purchase-product').value);
        let qty = Number(document.getElementById('purchase-qty').value);
        let cost = Number(document.getElementById('purchase-cost').value);
        if(!id || !qty) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');
        
        let p = products.find(x=>x.id===id);
        let oldVal = p.stock * p.cost;
        let newVal = qty * cost;
        p.stock += qty;
        p.cost = Number(((oldVal+newVal)/p.stock).toFixed(2));
        
        purchases.push({date:new Date().toLocaleString('th-TH'), productName:p.name, productId:p.id, qty, unitCost:cost});
        saveData(); renderPurchaseSection(); Swal.fire({icon:'success',title:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß',timer:1000,showConfirmButton:false, confirmButtonColor: '#569e83'});
        document.getElementById('purchase-qty').value='';
    }
    function delPurchase(idx) {
        const p = purchases[idx];
        const prod = products.find(x=>x.id===p.productId);
        if(prod && prod.stock >= p.qty) {
            prod.stock -= p.qty;
            purchases.splice(idx,1);
            saveData(); renderPurchaseSection();
        } else { Swal.fire('‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏Ç‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß','error'); }
    }

    // --- 6. SETTINGS ---
    function exportData() {
        const data = JSON.stringify({ products, transactions, purchases });
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `wanyai_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.products && data.transactions) {
                    Swal.fire({
                        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
                        text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏•‡∏¢',
                        confirmButtonColor: '#569e83'
                    }).then((r) => {
                        if(r.isConfirmed) {
                            localStorage.setItem('products_v7', JSON.stringify(data.products));
                            localStorage.setItem('transactions_v7', JSON.stringify(data.transactions));
                            localStorage.setItem('purchases_v7', JSON.stringify(data.purchases || []));
                            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà', 'success').then(() => location.reload());
                        }
                    });
                } else { Swal.fire('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö', 'error'); }
            } catch(err) { Swal.fire('Error', '‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error'); }
        };
        reader.readAsText(file);
    }

    function clearAllData() {
        Swal.fire({title:'‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?',text:'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{
            if(r.isConfirmed) { localStorage.clear(); location.reload(); }
        });
    }

    // --- INIT ---
    renderDashboard();
</script>
</body>
</html>
